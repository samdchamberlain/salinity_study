---
title: 'Supplemental Materials: TBN'
author: Samuel D Chamberlain^1^
date: '`r Sys.Date()`'
output:
  word_document: default
  pdf_document: default
  html_document: default
fontsize: 12pt
header-includes:
- \usepackage{setspace}
- \doublespacing
- \usepackage{hyperref}
link-citations: yes
csl: global-change-biology.csl
bibliography: library.bib
---

^1^Department of Environmental Science, Policy, and Management, University of California, Berkeley, California, USA

```{r setup, include=FALSE}
#setwd to main package directory
knitr::opts_knit$set(root.dir = normalizePath("../"))

knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>")

knitr::opts_chunk$set(echo = FALSE, warning=FALSE)
```

```{r packages, message=FALSE}
library(knitr)
library(tidyverse)
library(lubridate)
library(gridExtra)
library(scales)
library(zoo)
library(ggpubr)
```

# Results
```{r load_process}
#load and process wetland sites into half-hourly, daily, and annual sums
source("R/peat6_processing.R") #wetland experiencing salinity rise
```

```{r bias_by_samples, fig.height= 5, fig.width=6}
#shuffle data for comparison w/ monthly gap magnitude retained

#create a growing month stamp
peat6_all$month <- month(peat6_all$datetime)
peat6_all$m_yr <- paste(peat6_all$year, peat6_all$month, sep = "")

#shuffle data for comparison w/ monthly gap magnitude retained
peat6_all <- peat6_all %>%
  group_by(month) %>%
  mutate(Ta_shuf = sample(TA.x, length(TA.x), replace = F),
         wm_shuf = sample(wm, length(wm), replace = F))

#create data list by month
by_month <- peat6_all %>%
  filter(year > 2011 & year < 2018) %>%
  group_by(m_yr) %>%
  nest()

clipped_monthly$T_shuf <- mi_timeseries(Ta_shuf, wm_shuf, data_list = by_month)

ggplot(clipped_monthly, aes(x = CH4_obs, y = T_shuf)) +
  stat_smooth(se = F) +
  geom_point(color = "red") +
  ylab(expression(bolditalic(MI)~"("~T[air]~","~F[CH4]~")")) +
  xlab("Total methane flux observations")
```

```{r causality_checks, fig.cap="Normalized transfer entropy (***T***) from (top panel) half-hourly T~a~ to F~CH4~ and (bottom panel) F~CH4~ to T~a~ over multiple growing seasons. The red line represents significance threshold (*P* < 0.05) based on Monte Carlo reshuffling of the time series. Based on ~a priori~ knowledge only changes in T~a~ should induce changes in F~CH4~, but not vice versa.", fig.height=4, fig.width=7.5, dpi=600}
source("R/TR_functions.R")
source("R/transformations.R")

#apply anomaly filter
anom_data <- peat6_all %>%
  arrange(year, time) %>%
  mutate(CH4_anom = anom_filter(wm_gf),
         TA_anom = anom_filter(TA.x),
         GPP_anom = anom_filter(gpp_ANNnight))

anom_data <- arrange(anom_data, datetime)
anom_data$CH4na_anom <- ifelse(is.na(anom_data$wm), NA, anom_data$CH4_anom) # re-insert missing values

# Focus only on high v. low salinity years without additional disturbance
# other disturbance includes the 2014 insect outbreak and 2017 flushing events
anom_data <- subset(anom_data, year %in% c(2012, 2013, 2015, 2016))

#create data list by annual growing season
by_year <- anom_data %>%
  filter(DOY > 100 & DOY < 300) %>%
  group_by(year) %>%
  nest()

#calculate lagged transfer entropy time series (up to 2 day lag at half-hourly timestep)
# for TA -> CH4
tr_wm_ta <- tr_timeseries(TA_anom, CH4na_anom, data_list = by_year, type = "observed", 
                           lags = 72, bins = 10, normalize = T)

mc_wm_ta <- tr_timeseries(TA_anom, CH4na_anom, data_list = by_year, type = "shuffled", 
                           lags = 72, bins = 10, runs = 25, alpha = 0.05, normalize = T)
# for CH4 -> TA
tr_ta_wm <- tr_timeseries(CH4na_anom, TA_anom, data_list = by_year, type = "observed", 
                           lags = 72, bins = 10, normalize = T)

mc_ta_wm <- tr_timeseries(CH4na_anom, TA_anom, data_list = by_year, type = "shuffled", 
                           lags = 72, bins = 10, runs = 25, alpha = 0.05, normalize = T)

#unlist data to tidy dataframe
wm.ta_df <- tidy_list(tr_ta_wm); wm.ta_shuf <- tidy_list(mc_ta_wm)
ta.wm_df <- tidy_list(tr_wm_ta); ta.wm_shuf <- tidy_list(mc_wm_ta)

a <- ggplot() +
  geom_line(data = ta.wm_df, aes(x = hour, y = tr)) +
  geom_line(data = ta.wm_shuf, aes(x = hour, y = tr), color = "red") +
  facet_wrap(~year, nrow = 1) +
  scale_x_continuous(breaks = seq(0, 48, by = 6)) +
  scale_y_continuous(limits = c(0, 0.04)) +
  ylab(expression(bolditalic(T)~"("~T[a] %->% F[CH4]~")"))

b <- ggplot() +
  geom_line(data = wm.ta_df, aes(x = hour, y = tr)) +
  geom_line(data = wm.ta_shuf, aes(x = hour, y = tr), color = "red") +
  facet_wrap(~year, nrow = 1) +
  scale_x_continuous(breaks = seq(0, 48, by = 6)) +
  scale_y_continuous(limits = c(0, 0.04)) +
  xlab("Lag (hours)")  + ylab(expression(bolditalic(T)~"("~F[CH4] %->% T[a]~")"))

#Multiple plots aligned
iA <- ggplotGrob(a)
iB <- ggplotGrob(b)

maxWidth = grid::unit.pmax(iA$widths[2:5], iB$widths[2:5])
iA$widths[2:5] <- as.list(maxWidth); iB$widths[2:5] <- as.list(maxWidth); 

grid.arrange(iA, iB, ncol=1)
```