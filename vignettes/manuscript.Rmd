---
title: "Salinity study"
author: Samuel D Chamberlain^1^, Elke Eichelmann^1^, Kyle S Hemes^1^, Daphne J Szutu^1^,
  Joseph G Verfaillie^1^, and Dennis D Baldocchi^1^
date: '`r Sys.Date()`'
output:
  html_document: default
  pdf_document: default
  word_document: default
link-citations: yes
header-includes:
- \usepackage{setspace}
- \doublespacing
- \usepackage{lineno}
- \linenumbers
- \usepackage{hyperref}
fontsize: 12pt
---

^1^Department of Environmental Science, Policy, and Management, University of California, Berkeley, California, USA

```{r setup, include=FALSE}
#setwd to main package directory
knitr::opts_knit$set(root.dir = normalizePath("../"))
options(digits=2)

knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>")

knitr::opts_chunk$set(echo = FALSE, warning=FALSE)
```

```{r packages, message=FALSE}
library(knitr)
library(tidyverse)
library(lubridate)
library(gridExtra)
library(scales)
library(zoo)
library(ggpubr)
library(caret)
library(modelr)
library(forecast)
library(entropy)
```

<!-- \newpage -->

<!-- # Abstract -->

<!-- # Introduction -->

<!-- # Materials and Methods -->

<!-- # Results -->
## Salinity effects
```{r load_process}
#load and process wetland sites into half-hourly, daily, and annual sums
source("R/peat6_processing.R") #wetland experiencing salinity rise
source("R/peat19_processing.R") #baseline mature wetland w/o salinity rise
```

```{r fig1, fig.height = 8, fig.width = 7}
peat6_sub <- select(peat6_daily, -starts_with("DO"), -starts_with("CO", ignore.case = F))

both_sites <- rbind(peat19_daily, peat6_sub)

a <- ggplot(subset(both_sites, year > 2013), aes(x=datetime, y=mgCH4, color=site)) +
  geom_point(size = 0.5)

b <- ggplot(subset(both_sites, year > 2013), aes(x=datetime, y=gCO2, color=site)) +
  geom_point(size = 0.5)

c <- ggplot(subset(both_sites, year > 2013)) +
  geom_line(aes(x=datetime, y=gER, color=site)) #+
  #geom_line(aes(x=datetime, y=gGEP, color=site))

d <- ggplot(subset(both_sites, year > 2013), aes(x=datetime, y=Tair, color=site)) +
  geom_line()

grid.arrange(a, b, c, d, ncol=1)
```

```{r fig2, fig.height=7, fig.width=4}
#Average monthly fluxes prior to salinity peak in 2016 
MBav <- subset(peat6_monthly, year > 2012 & year < 2016) %>%
  group_by(month) %>%
  summarise(CH4 = mean(gCH4),
            sdCH4 = 1.96*sd(gCH4)/sqrt(length(gCH4)),
            NEE = mean(gNEE),
            sdNEE = 1.96*sd(gNEE)/sqrt(length(gNEE)),
            ER = mean(gER),
            sdER = 1.96*sd(gER)/sqrt(length(gER)),
            GEP = mean(gGEP),
            sdGEP = 1.96*sd(gGEP)/sqrt(length(gGEP)),
            n = length(gCH4))

#Mean conductivity on Twitchell Island without salinity rise
Tw_av <- rbind(peat19_monthly, peat6_monthly) %>%
  group_by(month) %>%
  summarise(sal = mean(mCond, na.rm=T),
            sdsal = 1.96*sd(mCond, na.rm=T)/sqrt(length(mCond)))


a <- ggplot() +
  geom_ribbon(data=MBav, aes(x=month, ymin=CH4-sdCH4, ymax=CH4+sdCH4), fill="light grey") +
  geom_line(data=MBav, aes(x=month, y=CH4)) +
  geom_line(data=subset(peat6_monthly, year==2015), aes(x=month, y=gCH4), color="#fdae61") +
  geom_line(data=subset(peat6_monthly, year==2016), aes(x=month, y=gCH4), color="#d7191c") +
  geom_line(data=subset(peat6_monthly, year==2017), aes(x=month, y=gCH4), color="#2c7bb6") +
  scale_x_continuous(name="Month", breaks=seq(0,12,2)) +
  ylab(expression(F[CH4]~" (g C"~m^{-2}~mo^{-1}~")")) + annotate("text", x=Inf, y=Inf, label="a ", vjust=1, hjust=1) +
  theme_bw() + theme(axis.title.x=element_blank())

b <- ggplot() +
  geom_ribbon(data=MBav, aes(x=month, ymin=ER-sdER, ymax=ER+sdER), fill="light grey") +
  geom_line(data=MBav, aes(x=month, y=ER)) +
  geom_line(data=subset(peat6_monthly, year==2015), aes(x=month, y=gER), color="#fdae61") +
  geom_line(data=subset(peat6_monthly, year==2016), aes(x=month, y=gER), color="#d7191c") +
  geom_line(data=subset(peat6_monthly, year==2017), aes(x=month, y=gER), color="#2c7bb6") +
  ylab(expression("ER (g C"~m^{-2}~mo^{-1}~")")) + annotate("text", x=Inf, y=Inf, label="b ", vjust=1, hjust=1) +
  scale_x_continuous(name="Month", breaks=seq(0,12,2)) +
  theme_bw() + theme(axis.title.x=element_blank())

c <- ggplot() +
  geom_ribbon(data=MBav, aes(x=month, ymin=GEP-sdGEP, ymax=GEP+sdGEP), fill="light grey") +
  geom_line(data=MBav, aes(x=month, y=GEP)) +
  geom_line(data=subset(peat6_monthly, year==2015), aes(x=month, y=gGEP), color="#fdae61") +
  geom_line(data=subset(peat6_monthly, year==2016), aes(x=month, y=gGEP), color="#d7191c") +
  geom_line(data=subset(peat6_monthly, year==2017), aes(x=month, y=gGEP), color="#2c7bb6") +
  ylab(expression("GEP (g C"~m^{-2}~mo^{-1}~")")) + annotate("text", x=Inf, y=Inf, label="c ", vjust=1, hjust=1) +
  scale_x_continuous(name="Month", breaks=seq(0,12,2)) +
  theme_bw() + theme(axis.title.x=element_blank())

d <- ggplot() +
  geom_ribbon(data=Tw_av, aes(x=month, ymin=sal-sdsal, ymax=sal+sdsal), fill="light grey") +
  geom_line(data=Tw_av, aes(x=month, y=sal)) +
  geom_line(data=subset(peat6_monthly, year==2015), aes(x=month, y=mCond), color="#fdae61") +
  geom_line(data=subset(peat6_monthly, year==2016), aes(x=month, y=mCond), color="#d7191c") +
  geom_line(data=subset(peat6_monthly, year==2017), aes(x=month, y=mCond), color="#2c7bb6") +
  ylab("Salinity")  + annotate("text", x=Inf, y=Inf, label="d ", vjust=1, hjust=1) +
  scale_x_continuous(name="Month", breaks=seq(0,12,2)) +
  theme_bw()

#Multiple plots aligned
g1 <- ggplotGrob(a)
g2 <- ggplotGrob(b)
g3 <- ggplotGrob(c)
g4 <- ggplotGrob(d)
g <- rbind(g1, g2, g3, g4, size="first");

grid.arrange(g)
```

## Models by year for comparison
```{r anomaly_filter, echo = F, message = F}
anom_filter <- function(var, window = 48*7) {
  var - ma(var, order = window)
}

test <- peat6_daily %>%
  ungroup() %>%
  select(mgCH4, gGEP, mET, H, Tair, mVPD, u., Rain, WTD) %>%
  map_df(anom_filter)
  
#cor(test, method = "spearman", use = "complete.obs")

```

```{r pca, echo = F}
subset <- peat6_daily %>%
  ungroup() %>%
  select(mgCH4, gGEP, mET, H, Tair, mVPD, u., Rain, WTD, Ts, Tw, PA, gER, Cond)

pca_test <- preProcess(subset, method = c("medianImpute"))
out_sub <- predict(pca_test, subset)

test <- prcomp(out_sub, scale. = T)

biplot(test)
```

```{r entropy_analysis_peat, fig.width = 7, fig.height= 8}
source("R/MI_functions.R")

# # test multiple binning strategies
# bin_v = seq(4, 22, by = 2)
# par(mfrow=c(2, 5))
# 
# for (i in bin_v) {
#   a <- lag_mi(peat6_all$ustar, peat6_all$wm, lags = 48, bins = i)
#   plot(a)
# }

#create a growing month stamp
peat6_all$month <- month(peat6_all$datetime)
peat6_all$m_yr <- paste(peat6_all$year, peat6_all$month, sep = "")

#shuffle data for comparison w/ monthly gap magnitude retained
peat6_all <- peat6_all %>%
  group_by(month) %>%
  mutate(H_shuf = sample(TA.x, length(TA.x), replace = F),
         wm_shuf = sample(wm, length(wm), replace = F))

#create data list by month
by_month <- peat6_all %>%
  filter(year > 2011 & year < 2018) %>%
  group_by(m_yr) %>%
  nest()

#plot that needs to be dealt with later
clipped_monthly <- subset(peat6_monthly, year > 2011 & year < 2018)
clipped_monthly$GPP_CH4_mi <- mi_timeseries(gpp_ANNnight, wm, data_list = by_month)
clipped_monthly$ET_CH4_mi <- mi_timeseries(H_shuf, wm_shuf, data_list = by_month)
clipped_monthly$Tair_CH4_mi <- mi_timeseries(TA.x, wm, data_list = by_month)

# # Monte Carlo significance thresholds (dont run everytime as they take a while)
# #sig_gpp <- conf_series(gpp_ANNnight, wm, data_list = by_month, runs = 1000)
# # mean sig_gpp across all months: 0.02311099
# 
# #sig_Tair <- conf_series(TA.x, wm, data_list = by_month, runs = 1000)
# # mean sig_Tair across all months: 0.03119986
#
# #sig_H <- conf_series(H_gf, wm, data_list = by_month, runs = 100)
# # mean sig_Tair across all months: 0.03119986

a <- ggplot(clipped_monthly) +
  geom_hline(yintercept = 0.02311099*2.36, size = 0.5, color = "dark green", linetype = "dashed") +
  geom_hline(yintercept = 0.03119986*2.36, size = 0.5, color = "red", linetype = "dashed") +
  #geom_hline(yintercept = mean(sig_H)*2.36, size = 0.5, color = "blue", linetype = "dashed") +
  geom_point(aes(x = datetime, y = Tair_CH4_mi), color = "red", alpha = 0.5) +
  geom_line(aes(x = datetime, y = ma(Tair_CH4_mi, 3)), color = "red", size = 1) +
  geom_point(aes(x = datetime, y = GPP_CH4_mi), color = "dark green", alpha = 0.5) +
  geom_line(aes(x = datetime, y = ma(GPP_CH4_mi, 3)), color = "dark green", size = 1) +
  geom_point(aes(x = datetime, y = ET_CH4_mi), color = "blue", alpha = 0.5) +
  geom_line(aes(x = datetime, y = ma(ET_CH4_mi, 3)), color = "blue", size = 1) +
  ylab("Mutual information") + theme_bw() + xlab("")

b <- ggplot(subset(peat6_daily, year > 2011 & year < 2018), aes(x=datetime, y=Cond)) +
  geom_line(color = "blue") +
  ylab("Conductivity (mS)") + theme_bw()
  
grid.arrange(a, b, ncol=1)
```

```{r bias_by_samples, fig.height= 5, fig.width=6}
#use monthly from above and compare to two month chunks

# create a bimonthly grouping
peat6_all$bimonth <- paste(peat6_all$year, floor((peat6_all$month+1)/2), sep="")

by_bimonth <- peat6_all %>%
  filter(year > 2011 & year < 2018) %>%
  group_by(bimonth) %>%
  nest()

#reshuffle by gap magnitude preserved
peat6_all <- peat6_all %>%
  group_by(bimonth) %>%
  mutate(H_shuf = sample(TA.x, length(TA.x), replace = F),
         wm_shuf = sample(wm, length(wm), replace = F))

#calculate bimonthly MI
clipped_bimonthly <- subset(peat6_monthly, year > 2011 & year < 2018)
clipped_bimonthly$bimonth <- paste(clipped_bimonthly$year, floor((clipped_bimonthly$month+1)/2), sep="")
clipped_bimonthly <- aggregate(clipped_bimonthly, by=list(clipped_bimonthly$bimonth), FUN=mean)

clipped_bimonthly$ET_CH4_mi <- mi_timeseries(H_shuf, wm_shuf, data_list = by_bimonth)

ggplot() +
  geom_point(data = clipped_monthly, aes(x = CH4_obs, y = ET_CH4_mi)) +
  geom_point(data = clipped_bimonthly, aes(x = CH4_obs, y = ET_CH4_mi), color = "red") +
  xlab("Number of flux obs.") + ylab("MI (reshuffled data)")
```

```{r test, echo = F}
#CH4sub <- peat6_all[!is.na(peat6_all$wm), ]

by_year <- peat6_daily %>%
  filter(year > 2011 & year < 2018) %>%
  group_by(year) %>%
  select(mgCH4, gGEP, mET, H, Tair, mVPD, u., Rain, WTD) %>%
  nest()

net_model <- function(df) {
  train(mgCH4 ~ ., data = df, method = "glmnet",
                 trControl = trainControl(method = "cv"),
                 preProcess = c("center", "scale", "medianImpute", "BoxCox"),
                 tuneGrid = expand.grid(.alpha = 1, .lambda = 0.1),
                 na.action = na.pass)
}

# hh_model <- function(df) {
#   train(wm ~ gpp_ANNnight + wq_gf + wt_gf + TA.y + VPD + ustar + PRECIP + WT + WD,
#         data = df,
#         method = "glmnet",
#         preProcess = c("center", "scale", "medianImpute", "BoxCox"),
#         na.action = na.pass)
# }

# subset <- peat6_daily %>%
#   ungroup() %>%
#   select(mgCH4, gGEP, gER, mET, H, Tair, Tw, mVPD, u., Rain, WTD) %>%
#   na.omit()

# #caret approach
# glm_reg <- train(wm ~ gpp_ANNnight + wq_gf + wt_gf + TA.y + VPD + ustar + PRECIP + WT + WD, 
#                  data = CH4sub, method = "glmnet",
#                  trControl = trainControl(method = "cv"),
#                  preProcess = c("center", "scale", "medianImpute"),
#                  #tuneGrid = expand.grid(.alpha = 1, .lambda = c(0, 0.001, 0.1, 1, 5, 10, 20, 50)),
#                  na.action = na.pass)

by_year <- by_year %>%
  mutate(model = map(data, net_model),
         Imp = map(model, varImp))

impo_list <- by_year$Imp

a <- impo_list[[1]]$importance
a$year <- 2012
a$vars <- rownames(a)

b <- impo_list[[2]]$importance
b$year <- 2013
b$vars <- rownames(b)

c <- impo_list[[3]]$importance
c$year <- 2014
c$vars <- rownames(c)

d <- impo_list[[4]]$importance
d$year <- 2015
d$vars <- rownames(d)

e <- impo_list[[5]]$importance
e$year <- 2016
e$vars <- rownames(e)

f <- impo_list[[6]]$importance
f$year <- 2017
f$vars <- rownames(f)

all_now <- do.call("rbind", list(a, b, c, d, e, f))

# ggplot(all_now, aes(x=year, y=Overall, color=vars)) +
#   #stat_smooth(se=F) +
#   geom_point(size = 2) +
#   geom_line()

# ggplot(all_now, aes(x = year, y = vars)) +
#   geom_tile(aes(fill = Overall))
```

<!-- ## Information theory approach -->


<!-- ## Water chemistry -->

<!-- ```{r fig4, echo = F} -->
<!-- only16 <- subset(peat6_daily, year > 2015) -->
<!-- only16$jday <- lubridate::yday(only16$datetime) -->

<!-- only16$season <- ifelse(only16$jday %in% c(0:100) | only16$jday %in% c(300:365), "fallow",  -->
<!--                            "growing") -->

<!-- # ggplot(only16, aes(x=datetime)) + -->
<!-- #   geom_line(aes(y = DOrange1), color="red") + -->
<!-- #   geom_line(aes(y = DOdiff), color="blue") -->
<!-- #  -->
<!-- # ggplot(only16, aes(x=mgCH4, y=DOrange1, color=season)) + -->
<!-- #   geom_point() -->

<!-- regr <- lm(DOrange1 ~ mgCH4, data = subset(only16, season == "growing")); summary(regr) -->
<!-- ``` -->

<!-- # Discussion -->

# Acknowledgements
This research was supported in part by the U.S. Department of Energyâ€™s Office of Science and its funding of Ameriflux core sites (Ameriflux contract 7079856), and the California Division of Fish and Wildlife, through a contract of the California Department of Water Resources (Award 4600011240).

# References

