---
title: Effect of drought-induced salinization on wetland methane emissions, gross
  ecosystem photosynthesis, and their interactions. Dynamic methane flux-driver
  relationships during a drought-induced wetland salinity disturbance event.
author: Samuel D Chamberlain^1^, Elke Eichelmann^1^, Kyle S Hemes^1^, Daphne J Szutu^1^,
  Joseph G Verfaillie^1^, and Dennis D Baldocchi^1^
date: '`r Sys.Date()`'
output:
  word_document: default
  pdf_document: default
  html_document: default
fontsize: 12pt
header-includes:
- \usepackage{setspace}
- \doublespacing
- \usepackage{lineno}
- \linenumbers
- \usepackage{hyperref}
link-citations: yes
csl: institute-of-physics-harvard.csl
bibliography: library.bib
---

^1^Department of Environmental Science, Policy, and Management, University of California, Berkeley, California, USA

```{r setup, include=FALSE}
#setwd to main package directory
knitr::opts_knit$set(root.dir = normalizePath("../"))
options(digits=2)

knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>")

knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```

```{r packages, message=FALSE}
# packages used
library(knitr)
library(tidyverse)
library(lubridate)
library(gridExtra)
library(scales)
library(zoo)
library(caret)
library(forecast)
library(entropy)
library(stringr)
library(wq)

# mutual info and transfer entropy functions
source("R/MI_functions.R")
source("R/TR_functions.R")
source("R/transformations.R")
source("R/signficance_tests.R")
```

# Abstract
Salinity gradients across estuaries influence wetland carbon storage, methane (CH~4~) biogeochemistry, and plant productivity. Estuarine freshwater wetlands may experience increases in salinity during droughts; however, the impact of salinization on ecosystem greenhouse gas (GHG) emissions is uncertain. Using eddy covariance flux data from a wetland experiencing salinization during the 2011-2017 California drought, we used information theory analyses to quantify couplings and information transfer between environmental drivers and CH~4~ fluxes and random forest models to quantify salinization-induced changes in CH~4~ fluxes and plant productivity. We observed dynamic CH~4~ flux-driver relationships across the disturbance regime, where temperature connections strengthened and productivity connections were dampened during salinization. Annual photosynthesis reduced 65% during peak salinization, whereas annual CH~4~ emissions reduced 10%, suggesting that other substrate sources compensated for reductions in photosynthates. Our results demonstrate the value of applying these approaches to ecological analyses and suggest drought-induced salinization may increase GHG emissions from estuarine wetlands. (150 words)

Body: 3915/4000 words

# 1. Introduction
Peatland restoration is proposed as a natural climate mitigation strategy due to long-term sequestration of carbon dioxide (CO~2~) in anoxic sediments [@griscom_natural_2017; @leifeld_underappreciated_2018], which also reverses CO~2~ emissions from the drained peat soils [@hatala_greenhouse_2012; @knox_agricultural_2015]. From a climate mitigation perspective, it is often assumed that methane (CH~4~) emissions from re-flooded landscapes are offset by carbon (C) storage over multi-century time scales [@mitsch_wetlands_2013; @griscom_natural_2017; @leifeld_underappreciated_2018]. Despite long-term climate benefits, CH~4~ emissions should be considered when assessing the greenhouse gas (GHG) benefit of wetland restoration given the short-term strength of CH~4~ emissions relative to CO~2~ uptake [@neubauer_moving_2015] and the rapid response of radiative forcing to changes in global CH~4~ emissions [@feldman_observationally_2018]. A growing literature, where ecosystem fluxes of CO~2~ and CH~4~ are measured *in situ* by eddy covariance [@baldocchi_fluxnet_2001], demonstrate that many wetlands are net GHG sources due to CH~4~ emissions over 20 to 100 year timescales [@petrescu_uncertain_2015]. There is a need to understand wetland responses to disturbance and management if the goal is to engineer systems with a limited climate footprint.

Estuarine wetlands and river deltas have experienced large-scale drainage and land surface subsidence [@syvitski_sinking_2009], and wetlands are restored in these regions to reverse subsidence [@miller_subsidence_2008] and promote long-term C sequestration [@kroeger_restoring_2017]. The Sacramento-San Joaquin Delta in the San Francisco Estuary of California has experienced substantial subsidence following drainage [@deverel_historic_2010], and wetlands are being restored to promote multiple ecosystem services, including sediment accretion, GHG emission reductions, and habitat creation [@deverel_implications_2017]. These freshwater restored wetlands generally experience stable, low salinity levels due to upstream water projects that store runoff for release during dry periods; however, salinity levels increase during droughts when freshwater resources are limited and saltwater intrudes up the San Francisco Bay [@enright_salinity_2009]. 

The ecological impacts of saltwater intrusion on wetlands are far reaching [@herbert_global_2015], impacting C cycling and export [@chambers_effect_2013; @ardon_drought_2016], nutrient cycling and biogeochemistry [@morrissey_salinity_2014; @dijk_salinization_2015], and biological community composition [@nielsen_modified_2009]. Salinity gradients in San Francisco Bay are the dominant control of wetland plant communities, where as salinity levels rise salt-intolerant species are stressed and replaced by salt-tolerant taxa [@watson_abundance_2009]. Methane emissions are also responsive to changing salinity, as CH~4~ production is inhibited in the presence of sulfate in seawater [@poffenbarger_salinity_2011]. For these reasons, GHG emissions from estuarine freshwater wetlands are likely responsive to salinization, yet the synergistic effects on methane biogeochemistry and productivity are not well understood. Increasing salinity can increase net GHG emissions due to stress-induced reductions in photosynthesis that offset reduced CH~4~ emissions [@neubauer_ecosystem_2013; @krauss_component_2016]. Additionally, gross ecosystem photosynthesis (*GEP*) provides substrate for wetland CH~4~ production [@hatala_gross_2012], so interpreting responses to salinization requires understanding interactions across fluxes. Understanding these interactive responses is important, as drought-induced saltwater intrusion impacts estuarine wetlands globally [@drexler_effect_2001; @barlow_saltwater_2010], and water resources will become more scarce for increasingly drought-affected Mediterranean regions [@iglesias_challenges_2007; @gao_increased_2008].

Understanding such responses can be challenging, as ecosystems are complex systems where non-linear, lagged, and feedback interactions are common [@ruddell_ecohydrologic_2009; @sturtevant_identifying_2016]. In some cases, findings from small-scale experiments may not be relevant to whole ecosystem dynamics [@schindler_dilemma_2012], which motivates quantifying dominant or causal interactions from *in situ* observations. A number of statistical approaches common to neuroscience and econometrics, yet relatively novel to ecology, are well-suited to this task [@rinderer_assessing_2018] and are useful for building a mechanistic understanding for predictive modeling  [@larsen_appropriate_2016; @getz_wayne_m_making_2017]. These include non-parametric information theory metrics, such as mutual information (*MI*), that can identify dominant lagged, non-linear, and non-monotonic relationships observed in flux time series [@sturtevant_identifying_2016; @chamberlain_soil_2018; @knox_direct_2018]. Other metrics aimed at identifying causal relationships, such as Granger causality, have been used to identify directed relationships between GHG fluxes in forest [@detto_causality_2012] and rice ecosystems [@hatala_gross_2012]. Transfer entropy (*TE*), a non-parametric measure equivalent to Granger causality under Gaussian conditions [@barnett_granger_2009], has also been applied to understand functional changes in ecosystems during drought [@ruddell_ecohydrologic_2009; @ruddell_ecohydrologic_2009-1] and how C cycling responds to restoration practices [@larsen_disrupted_2017]. These methods provide a powerful means to understand ecosystem functional changes from observational data.

The objectives of this study were to determine the effect of drought-induced salinization on CO~2~ and CH~4~ fluxes from restored freshwater wetlands in the Sacramento-San Joaquin Delta of California, USA. We measured ecosystem-scale CO~2~ and CH~4~ fluxes by eddy covariance from a restored wetland that experienced a substantial rise in salinity over the course of the 2011-2017 California drought. We used (1) information theory metrics to identify how couplings and causal relationships between temperature, *GEP*, and CH~4~ fluxes varied over the course of wetland salinization, and (2) used random forest models to quantify the overall reduction in *GEP* and CH~4~ fluxes due to salinization. Understanding and predicting the response of Delta wetland GHG exchange to salinization events is important from a policy perspective, as wetland restoration in the region is funded through California's Cap-and-Trade Program [@deverel_implications_2017; @oikawa_evaluation_2017] and freshwater is projected to become an increasingly limited resource in the state's future [@vicuna_sebastian_sensitivity_2007].

# 2. Methods
## 2.1 Study Site and Flux Measurements
We measured ecosystem-scale fluxes of CO~2~ and CH~4~ for seven years from a restored wetland in the Sacramento-San Joaquin Delta of California, USA (Ameriflux site Us-Myb; N 38.0498, W 121.7650). The wetland was restored in 2010 on a former pasture, and our measurements began at the point of initial restoration and re-flooding. The site is predominantly vegetated with cattails (*Typha* spp.) and some tules (*Schoenoplectus acutus*), and the water table is managed to stay above the land surface. We compared findings from this site to a nearby reference wetland site (Ameriflux site Us-Tw1; N 38.1074, W 121.6469), restored in 1999, that did not experience an increase in salinity. More description of this mature reference site can be found in @miller_plant_2010 and @eichelmann_effect_2018.

Fluxes were measured continuously by eddy covariance and were integrated over half-hour periods from the covariance of vertical wind velocity and gas concentrations measured at 20 Hz frequency using a 3-dimensional sonic anemometer (Gill WindMaster; Gill Instruments Ltd, Lymington, Hampshire, England) and open-path infrared gas analyzers (LI-7500 & LI-7700; LI-COR, Lincoln, NE, USA). Standardized flux corrections and quality control were applied, including high-frequency data despiking, 2-D coordinate rotations, density corrections, and site-specific friction velocity (*u$^\ast$*) filtering. Data gaps were filled using artificial neural networks (ANNs), and net CO~2~ exchange was partitioned into ecosystem respiration (*ER*) and *GEP* by training an ANN on nighttime CO~2~ fluxes and predicting *ER* at all times. *GEP* was estimated as the difference between *NEE* and *ER*. Site instrumentation and descriptions are described in greater detail in @eichelmann_effect_2018, quality control procedures are described in more detail in @knox_agricultural_2015 and @chamberlain_evaluation_2017, and gap-filling and partitioning in @baldocchi_does_2015. Partitioning methods perform well against independent soil respiration measures [@oikawa_revisiting_2017]. Water conductivity was measured using stainless-steel electrodes (CS547A-L; Campbell Scientific, Logan, UT, USA) and air temperature using shielded and aspirated thermistor and capacitance sensors (HMP45; Viasala, Vantaa, Finland). Conductivity was converted to practical salinity units (psu) using relationships with water temperature based on the Practical Salinity Scale [@fofonoff_seawater_1983].

## 2.2 Information Theory Methods
We used mutual information (*MI*) to identify *undirected* couplings between variables and transfer entropy (*TE*) to infer *directed*, or causal, interactions between variables. Mutual information quantifies the amount of information shared between two variables *X* and *Y*, or the reduction of uncertainty given knowledge of another variable, and can be described using the following equation:
$$MI_{X,Y}=H_X+H_Y-H_{X,Y}$$
where *H~X~* and *H~Y~* are marginal Shannon entropies of each variable, and *H~Y,X~* is the joint Shannon entropy of *X* and *Y*. Marginal entropies are calculated from the probability distributions of a variable as follows:
$$H_Y=-\sum_{y_t}p(y_t)log_2p(y_t)$$
And joint entropies are calculated from the joint probability distributions of two variables as follows:
$$H_{X,Y}=-\sum_{x_t}\sum_{y_t}p(x_t,y_t)log_2p(x_t,y_t)$$
where *x~t~* and *y~t~* are states within the overall distribution of *X* and *Y*.

We calculated mutual information (*MI*) for one-month blocks across the entire flux time series to quantify the change in couplings across the salinity disturbance event. For each month, continuous variables were discretized to 10 bins of equivalent length across the range of each variable. Mutual information was then calculated for each variable pair of interest (*Ta*,*F~CH4~* and *GEP*,*F~CH4~*), and significance thresholds were computed from the 95^th^ percentile (*P* < 0.05) of 1000 Monte Carlo reshufflings of the independent variable (*Ta* or *GEP*). Because the reshuffled values (*MI'*) vary with the number of CH~4~ flux observations per month (figure S1) we present *MI-MI'*, similar to @larsen_disrupted_2017, such that any values in Figs. 1 and 2 greater than zero are significant couplings.

Transfer entropy quantifies directional information transfer, or more technically, the extent to which knowledge of a variables *X* reduced the uncertainty of the present state of *Y* given knowledge of the history of *Y* itself. If a value of *TE* is above some significance threshold, it is deduced that information flows from *X* to the current state of *Y* [@ruddell_ecohydrologic_2009]. Transfer entropy can also be described by joint and marginal entropies incorporating time lags as follows [@knuth_revealing_2013; @ruddell_ecohydrologic_2009]:
$$T(X>Y, \tau) = H(X_{t-\tau}, Y_{t-1}) + H(Y_{t}, Y_{t-1}) - H(Y_{t-1}) - H(X_{t-\tau}, Y_{t}, Y_{t-1})$$
In the above formulation, we assume the immediate history of *Y* (t-1; i.e. the preceding half-hour in eddy flux time series) contributes the most information to the current state of *Y*, and we calculate *TE* across multiple lags of *X* ($\tau$) to identify dominant timescale of interactions [@ruddell_ecohydrologic_2009; @larsen_disrupted_2017]. More detail on applying transfer entropy (*TE*) to ecosystem-atmosphere fluxes can be found in @ruddell_ecohydrologic_2009, and we follow the basic protocols outlined in this work. This includes building discrete probability distributions using 10 bins for each variable as described above, transforming variables prior to *TE* calculations using a 5-day anomaly filter, and again establishing significance thresholds using Monte Carlo reshuffling of the flux time series. We calculate *TE* for information flow from *Ta* to *F~CH4~* and *GEP* to *F~CH4~*, and did so across multiple lags of the independent variable up to 60 hours. Similarly, we calculated significance thresholds for *TE* at each lag and used 1000 reshufflings at each lag. Calculations of transfer entropy are data intensive [@ruddell_ecohydrologic_2009], so we calculate *TE* for entire growing seasons each year (DOY 100-300) similar to @sturtevant_identifying_2016 and @chamberlain_soil_2018. We present both *MI* and *TE* in their relative form, normalized by the entropy of the *Y* variable (*F~CH4~*), so the values represent reductions in the uncertainty of CH~4~ fluxes [@larsen_disrupted_2017]. All information theory calculations were conducted using R 3.3.2 [@r_citation] with the 'entropy' package and home built functions to calculate *TE* and significance thresholds available online with this manuscript (https://github.com/samdchamberlain/salinity_study).

## 2.3 Salinity Impacts on Annual Fluxes
To quantify the reduction in *GEP* and *F~CH4~* due to salinity effects, we trained random forest models on fluxes measured during years prior to the salinity rise (2012-2014) using common meteorological drivers of each flux. Predictions are therefore representative of salinity 'naive' ecosystem function. Random forests are an ensemble tree-based method where numerous trees are constructed using bootstrap samples from the training dataset, and the trees are averaged to generate a final prediction. For each tree, a random subset of the predictors (*m~try~*) are chosen at each split to reduce overfitting [@breiman_random_2001]. We used an ensemble of 500 trees, and the *m~try~* value (ranging from 2-4) was chosen by using the model formulation with the lowest root mean squared error following five-fold cross-validation [@kuhn_applied_2013]. Any missing values in the predictor data were imputed using medians. 

We trained the models using common meteorological predictor variables that would not be affected by changes in local salinity, with the exception of *GEP* in the CH~4~ flux model based on previous findings in this region [@hatala_gross_2012]. For the *GEP* model, this included *Ta*, photosynthetically active radiation (*PAR*), vapor pressure deficit (*VPD*), air pressure (*PA*), and friction velocity (*u$^\ast$*), and the CH~4~ flux model included *GEP*, *Ta*, *VPD*, *PA*, and *u$^\ast$*. The tuned random forest models were then used to generate predictions of CH~4~ flux and *GEP* during the high salinity years (2015-2016), and we quantified the effect of salinization as the difference between observed fluxes and model predictions. Random forests were fit using the 'caret' [@caret] and 'randomForest' [@randomForest] packages. All additional data processing, statistical analysis, and visualization were conducted using the 'tidyverse' [@tidyverse], 'zoo' [@zoo], 'gridExtra' [@gridExtra], 'lubridate' [@lubridate], and 'scales' [@scales] packages. This manuscript is reproducible via R Markdown, and its code can be found at https://github.com/samdchamberlain/salinity_study.

# 3. Results
```{r load_process}
#load and process wetland sites into half-hourly, daily, and annual sums
source("R/peat6_processing.R") #wetland experiencing salinity rise
source("R/peat19_processing.R") #baseline mature wetland w/o salinity rise
```

We observed a substantial increase in salinity over the course of the observation period. Salinity levels were relatively stable from 2012 through 2013, began to rise through 2014, peaked in 2016, and reduced rapidly in 2017 when managers flushed the wetland with freshwater (figure 1). Substantial inter-annual variability was observed in *GEP* and *ER* fluxes, where the first-year post-restoration (2012) monthly fluxes were very large, followed by low fluxes in 2013. Methane fluxes were more stable but reduced across the measurement period (figure S2). In 2016 when salinity peaked, all late season fluxes were low compared to previous years (figure S2). Fluxes remained low into 2017, and late season fluxes increased substantially coincident with freshwater flushing (figure S2).

Coupling between driver variables (*GEP* and *Ta*) and *F~CH4~* were similar in the pre-disturbance period (2012 through 2014) where *MI* varied seasonally and was of similar magnitude for *MI~Ta,FCH4~* and *MI~GEP,FCH4~* (figure 1). During 2014, *MI* did not display a similar seasonality, presumably due to a large-scale insect outbreak that affected the wetland, though a late season increase in *MI* was still observed for both *MI~Ta,FCH4~* and *MI~GEP,FCH4~*. In 2015 and 2016 during peak salinization, we observed a strong decoupling between *GEP* and *F~CH4~*, and a strengthened coupling between *Ta* and *F~CH4~* (figure 1). The decoupling of *GEP* and *F~CH4~* was not driven by reduced *GEP*, as *GEP* magnitudes in 2015 were similar to previous years (figure S2). During 2017 when salinity levels dropped steeply, couplings between *GEP* and *F~CH4~* began to recover but were highly variable throughout the season (figure 1). These dynamics are somewhat observable in Kendall's tau, but patterns are obscured by large negative coefficients in winter periods (figure S3).

```{r fig1, fig.cap="Monthly relative mutual information (*MI*; top panel) shared between *GEP* and *F~CH4~* (green) as well as *Ta* and *F~CH4~* (red) at the salinization wetland. All *MI* values are corrected using 1000 Monte Carlo reshufflings of time series, such that *MI* > 0 are statistically significant at *P* < 0.05. Lines represent 3 month running means. Bottom panel displays daily mean salinity (psu).", fig.width=7, fig.height=5, dpi=600}

## Processing for high salinity wetland
#create a growing month stamp
peat6_all$month <- month(peat6_all$datetime)
peat6_all$m_yr <- paste(peat6_all$year, peat6_all$month, sep = "")

#create data list by month
by_month <- peat6_all %>%
  filter(year > 2011 & year < 2018) %>%
  group_by(m_yr) %>%
  nest()

#plot that needs to be dealt with later
clipped_monthly <- subset(peat6_monthly, year > 2011 & year < 2018)
clipped_monthly$date <- as.Date(clipped_monthly$datetime)
clipped_monthly$GPP_CH4_mi <- mi_timeseries(gpp_ANNnight, wm, data_list = by_month, bins = 10)
clipped_monthly$Tair_CH4_mi <- mi_timeseries(TA.x, wm, data_list = by_month, bins = 10)

# Monte Carlo significance thresholds (dont run everytime as they take a while)
sig_gpp <- conf_series(gpp_ANNnight, wm, data_list = by_month, type = "MI",
                       runs = 100, alpha = 0.05, bins = 10)
sig_Tair <- conf_series(TA.x, wm, data_list = by_month, type = "MI",
                        runs = 100, alpha = 0.05, bins = 10)

# Correct MI values of bias due to sample size, now anything over zero is significant at p < 0.05
clipped_monthly$TairMI_corrected <- clipped_monthly$Tair_CH4_mi - sig_Tair
clipped_monthly$gppMI_corrected <- clipped_monthly$GPP_CH4_mi - sig_gpp

a <- ggplot(clipped_monthly) +
  geom_point(aes(x = date, y = TairMI_corrected), color = "red", alpha = 0.5) +
  geom_line(aes(x = date, y = ma(TairMI_corrected, 3)), color = "red", size = 1) +
  geom_point(aes(x = date, y = gppMI_corrected), color = "dark green", alpha = 0.5) +
  geom_line(aes(x = date, y = ma(gppMI_corrected, 3)), color = "dark green", size = 1) +  
  scale_x_date(date_breaks = "1 year", labels = date_format("%Y")) +
  scale_y_continuous(limits = c(0, 0.3)) +
  ylab(expression(bolditalic(MI)~"(x,"~F[CH4]~")")) + xlab("") + ggtitle("Salinization wetland") +
  theme_bw()

b <- ggplot(subset(peat6_daily, year > 2011 & year < 2018), aes(x=as.Date(datetime), y=Sal)) +
  geom_line(color = "blue") +
  scale_y_continuous(limits = c(0, 7)) +
  scale_x_date(date_breaks = "1 year", labels = date_format("%Y")) +
  ylab("Salinity (psu)") + xlab("Year") +
  theme_bw()

#Multiple plots aligned
iA <- ggplotGrob(a)
iB <- ggplotGrob(b)

maxWidth = grid::unit.pmax(iA$widths[2:5], iB$widths[2:5])
iA$widths[2:5] <- as.list(maxWidth); iB$widths[2:5] <- as.list(maxWidth); 

grid.arrange(iA, iB, ncol=1)
```

These dynamics stand in contrast to the stable couplings observed at the nearby wetland that did not experience salinization, where we observed similar magnitudes and patterns for *MI~Ta,FCH4~* and *MI~GEP,FCH4~* across all years (figure 2). No decoupling of *F~CH4~* and *GEP* occurred during 2015 and 2016 when salinity levels did not increase at this wetland. Flux magnitudes were often similar to or larger than fluxes at the salinization wetland, particularly during the high salinity periods (figure S4).

```{r fig2, fig.cap="Monthly relative mutual information (*MI*; top panel) shared between *GEP* and *F~CH4~* (green) as well as *Ta* and *F~CH4~* (red) at the reference wetland with no salinity increase. All *MI* values are corrected using 1000 Monte Carlo reshufflings of time series, such that *MI* > 0 are statistically significant at *P* < 0.05. Only positive *MI* are shown, and lines represent 3 month running means. Bottom panel displays daily mean salinity (psu).", fig.width=7, fig.height=5, dpi=600}

#create a growing month stamp
peat19_all$month <- month(peat19_all$datetime)
peat19_all$m_yr <- paste(peat19_all$year, peat19_all$month, sep = "")

#create data list by month
by_month <- peat19_all %>%
  filter(year > 2012 & year < 2018) %>%
  group_by(m_yr) %>%
  nest()

#plot that needs to be dealt with later
clipped_monthly <- subset(peat19_monthly, year > 2012 & year < 2018)
clipped_monthly$date <- as.Date(clipped_monthly$datetime)
clipped_monthly$GPP_CH4_mi <- mi_timeseries(gpp_ANNnight, wm, data_list = by_month, bins = 10)
clipped_monthly$Tair_CH4_mi <- mi_timeseries(TA.x, wm, data_list = by_month, bins = 10)

# Monte Carlo significance thresholds (dont run everytime as they take a while)
sig_gpp <- conf_series(gpp_ANNnight, wm, data_list = by_month, type = "MI", 
                       runs = 100, alpha = 0.05, bins = 10)
sig_Tair <- conf_series(TA.x, wm, data_list = by_month, type = "MI",
                        runs = 100, alpha = 0.05, bins = 10)

# Correct MI values of bias due to sample size, now anything over zero is significant at p < 0.05
clipped_monthly$TairMI_corrected <- clipped_monthly$Tair_CH4_mi - sig_Tair
clipped_monthly$gppMI_corrected <- clipped_monthly$GPP_CH4_mi - sig_gpp

a <- ggplot(clipped_monthly) +
  geom_point(aes(x = date, y = TairMI_corrected), color = "red", alpha = 0.5) +
  geom_line(aes(x = date, y = ma(TairMI_corrected, 3)), color = "red", size = 1) +
  geom_point(aes(x = date, y = gppMI_corrected), color = "dark green", alpha = 0.5) +
  geom_line(aes(x = date, y = ma(gppMI_corrected, 3)), color = "dark green", size = 1) +  
  scale_x_date(date_breaks = "1 year", labels = date_format("%Y")) +
  scale_y_continuous(limits = c(0, 0.3)) +
  ylab(expression(bolditalic(MI)~"(x,"~F[CH4]~")")) + xlab("") + ggtitle("Baseline wetland") +
  theme_bw()

b <- ggplot(subset(peat19_daily, year > 2012 & year < 2018), aes(x=as.Date(datetime), y=Sal)) +
  geom_line(color = "blue") +
  scale_x_date(date_breaks = "1 year", labels = date_format("%Y")) +
  scale_y_continuous(limits = c(0, 7)) +
  ylab("Salinity (psu)") + xlab("Year") +
  theme_bw()
  
#Multiple plots aligned
iA <- ggplotGrob(a)
iB <- ggplotGrob(b)

maxWidth = grid::unit.pmax(iA$widths[2:5], iB$widths[2:5])
iA$widths[2:5] <- as.list(maxWidth); iB$widths[2:5] <- as.list(maxWidth); 

grid.arrange(iA, iB, ncol=1)
```

We observed a similar transition between the low salinity period (2012-2013) and the high salinity period (2015-2016) in *TE* from *GEP* or *Ta* to *F~CH4~* (figure 3). During the low salinity years, we observed similar magnitude information transfers from *GEP* to *F~CH4~* (*TE*(*GEP* > *F~CH4~*)) and from *Ta* to *F~CH4~* (*TE*(*Ta* > *F~CH4~*)). Significant *TE*(*GEP* > *F~CH4~*) occurred between 0-12 hour time lags and at similar lag periods from the previous two days (figure 3). These transfers were still observable during 2015, though over condensed lag periods. During peak salinity in 2016, only weak significant *TE*(*GEP* > *F~CH4~*) was observed at 0-3 hour lags and a small window near 48 hours (figure 3). Significant *TE* spikes should be interpreted with caution because ~ 6 values should occur by chance at *P* < 0.05 across the 120 lags evaluated.

We observed a very different dynamic in *TE*(*Ta* > *F~CH4~*) that mirrors *MI* observations, where *TE*(*Ta* > *F~CH4~*) was of similar magnitude to *TE*(*GEP* > *F~CH4~*) during the low salinity years, and *TE*(*Ta* > *F~CH4~*) strengthened during the high salinity 2015 and 2016 (figure 3). Under most conditions, *Ta* at lags up to ~30 hours affected current CH~4~ fluxes, with additional significant transfers around 48 hours (figure 3). Transfer entropy from 2014 and 2017 is not presented because the wetland experienced an insect outbreak and flushing disturbance, respectively, and obscure our ability to evaluate the effect of salinization alone. We observed no significant transfer of information from *F~CH4~* to *Ta* (figure S5), as expected since biological trace gas fluxes should not alter regional meteorological conditions.

```{r fig3, fig.cap="Relative transfer entropy (*TE*) from (top panel) half-hourly *GEP* to *F~CH4~* and (bottom panel) *Ta* to *F~CH4~* over the growing season during low salinity (2012-2013) and high salinity (2015-2016) periods. The red line represents a significance threshold (*P* < 0.05) based on Monte Carlo reshuffling of the time series calculated at each lag. Other lines represented *TE* at various lags of *GEP* or *Ta*, and the color scale shows mean salinity (psu) during the respective year. Years 2014 and 2017 are omitted from analysis because other disturbance events affected wetlands processes and confound analyses.", fig.height=4, fig.width=7.5, dpi=600}

#apply anomaly filter
anom_data <- peat6_all %>%
  arrange(year, time) %>%
  mutate(CH4_anom = anom_filter(wm_gf),
         TA_anom = anom_filter(TA.x),
         GPP_anom = anom_filter(gpp_ANNnight))

anom_data <- arrange(anom_data, datetime)
anom_data$CH4na_anom <- ifelse(is.na(anom_data$wm), NA, anom_data$CH4_anom) # re-insert missing values

# Focus only on high v. low salinity years without additional disturbance
# other disturbance includes the 2014 insect outbreak and 2017 flushing events
anom_data <- subset(anom_data, year %in% c(2012, 2013, 2015, 2016))

#create data list by annual growing season
by_year <- anom_data %>%
  filter(DOY > 100 & DOY < 300) %>%
  group_by(year) %>%
  nest()

#calculate lagged transfer entropy time series (up to 2 day lag at half-hourly timestep)
# for GPP -> CH4
tr_wm_gpp <- tr_timeseries(GPP_anom, CH4na_anom, data_list = by_year, type = "observed",
                           lags = 120, bins = 10, normalize = T)

mc_wm_gpp <- tr_timeseries(GPP_anom, CH4na_anom, data_list = by_year, type = "shuffled",
                           lags = 120, bins = 10, runs = 10, alpha = 0.05, normalize = T)
# for TA -> CH4
tr_wm_ta <- tr_timeseries(TA_anom, CH4na_anom, data_list = by_year, type = "observed",
                           lags = 120, bins = 10, normalize = T)

mc_wm_ta <- tr_timeseries(TA_anom, CH4na_anom, data_list = by_year, type = "shuffled",
                           lags = 120, bins = 10, runs = 10, alpha = 0.05, normalize = T)

#unlist data to tidy dataframe
gpp.wm_df <- tidy_list(tr_wm_gpp); gpp.wm_shuf <- tidy_list(mc_wm_gpp)
ta.wm_df <- tidy_list(tr_wm_ta); ta.wm_shuf <- tidy_list(mc_wm_ta)

#add mean annual conductivity to dataframes by year
mean_sal <- anom_data %>%
  filter(DOY > 100 & DOY < 300) %>%
  group_by(year) %>%
  summarise(`Sal. (psu)` = mean(sal, na.rm = T))

gpp.wm_df <- merge(gpp.wm_df, mean_sal, all.x = T)
ta.wm_df <- merge(ta.wm_df, mean_sal, all.x = T)

a <- ggplot() +
  geom_line(data = gpp.wm_df, aes(x = hour, y = tr, color = `Sal. (psu)`)) +
  geom_line(data = gpp.wm_shuf, aes(x = hour, y = tr), color = "red") +
  facet_wrap(~year, nrow = 1) +
  scale_x_continuous(breaks = seq(0, 60, by = 12)) +
  scale_y_continuous(limits = c(0.005, 0.04)) +
  xlab("") + ylab(expression(bolditalic(TE)~"("~GEP %->% F[CH4]~")")) +
  theme(legend.margin = margin(0, 0, 0, 0),
        legend.position=c(.82, .7), legend.key.size =  unit(0.1, "in"),
        legend.text = element_text(size=8), legend.title = element_text(size=8.5, face = "bold"),
        legend.background = element_rect(fill = "transparent"))

b <- ggplot() +
  geom_line(data = ta.wm_df, aes(x = hour, y = tr, color = `Sal. (psu)`)) +
  geom_line(data = ta.wm_shuf, aes(x = hour, y = tr), color = "red") +
  facet_wrap(~year, nrow = 1) +
  scale_y_continuous(limits = c(0.005, 0.04)) +
  scale_x_continuous(breaks = seq(0, 60, by = 12)) +
  xlab("Lag (hours)") + ylab(expression(bolditalic(TE)~"("~T[a] %->% F[CH4]~")")) +
  theme(legend.position = "none")

#Multiple plots aligned
iA <- ggplotGrob(a)
iB <- ggplotGrob(b)

maxWidth = grid::unit.pmax(iA$widths[2:5], iB$widths[2:5])
iA$widths[2:5] <- as.list(maxWidth); iB$widths[2:5] <- as.list(maxWidth);

grid.arrange(iA, iB, ncol=1)
```

```{r pre_salinity_models}
# train nn model on pre-salinity rise years and use to calculate reduction in component fluxes 
pre_rise <- peat6_daily %>%
  filter(year > 2011 & year < 2015) %>%
  select(mgCH4, gGEP, gER, mET, PAR, H, Tair, Tw, Ts, mVPD, PA, u., Rain, WTD)

set.seed(1000)
# Random forest model for GEP trained pre-salinity rise
pre_GEP <- train(gGEP ~ Tair + PAR + mVPD + PA + u., data = pre_rise,
                      method = "rf",
                      trControl = trainControl(method = "cv", number = 5),
                      preProcess = c("medianImpute"),
                      tuneGrid = expand.grid(.mtry = c(2, 3, 4)),
                      na.action = na.pass)

set.seed(2000)
# Random forest model for FCH4 trained pre-salinity rise
pre_CH4 <- train(mgCH4 ~ gGEP + Tair + mVPD + PA + u., data = pre_rise,
                      method = "rf",
                      trControl = trainControl(method = "cv", number = 5),
                      preProcess = c("medianImpute"),
                      ntree = 1000,
                      tuneGrid = expand.grid(.mtry = c(2, 3, 4)),
                      na.action = na.pass)

# # generate predictions for high salinity years for GEP and FCH4
# pre_rise$GEPpred <- predict.train(pre_GEP, pre_rise, na.action = na.pass)
# pre_rise$CH4pred <- predict.train(pre_CH4, pre_rise, na.action = na.pass)
# 
# # save ob v. pred summary statistics
# GEPregr <- summary(lm(gGEP ~ GEPpred, data = pre_rise))
# CH4regr <- summary(lm(mgCH4 ~ CH4pred, data = pre_rise))
# 
# a <- ggplot(pre_rise, aes(x = CH4pred, y = mgCH4)) +
#   geom_point(alpha = 0.25) +
#   geom_abline(intercept = 0, slope = 1) +
#   xlab(expression(F[CH4-Pred.]~" (mg C"~m^{-2}~d^{-1}~")")) +
#   ylab(expression(F[CH4-Obs.]~" (mg C"~m^{-2}~d^{-1}~")")) +
#   ggtitle("Pre-salinity rise (2012-2014)")
# 
# b <- ggplot(pre_rise, aes(x = GEPpred*-1, y = gGEP*-1)) +
#   geom_point(alpha = 0.25) +
#   geom_abline(intercept = 0, slope = 1) +
#   ylab(expression(GEP[Obs.]~"("~g~C~m^{-2}~d^{-1}~")")) +
#   xlab(expression(GEP[Pred.]~"("~g~C~m^{-2}~d^{-1}~")"))
# 
# grid.arrange(a, b, ncol = 1)
```

```{r fig4, fig.cap="Daily observed (black) and modeled (red) methane flux (*F~CH4~*; top panel) and gross ecosystem photosynthesis (*GEP*; bottom panel) during the high salinity period. Model predictions were made using random forest models trained on data collected in previous years (2012-2014) when salinity levels were low.", fig.width=7.5, fig.height=4, dpi=600}
# extract data to make predictions on the salinity rise years
rise_years <- peat6_daily %>%
  filter(year > 2014 & year < 2017) %>%
  select(datetime, year, mgCH4, gGEP, gER, mET, PAR, H, Tair, Tw, Ts, mVPD, PA, u., Rain, WTD)

# generate predictions for high salinity years for GEP and FCH4
rise_years$GEPpred <- predict.train(pre_GEP, rise_years, na.action = na.pass)
rise_years$CH4pred <- predict.train(pre_CH4, rise_years, na.action = na.pass)

#plotting all the measures
a <- ggplot(rise_years) +
  geom_line(aes(x=datetime, y=mgCH4)) +
  geom_line(aes(x=datetime, y=CH4pred), color = "red") +
  ylab(expression(F[CH4]~" (mg C"~m^{-2}~d^{-1}~")")) + xlab("") +
  ggtitle("High salinity period (2015-2016)") +
  theme_classic()

b <- ggplot(rise_years) +
  geom_line(aes(x=datetime, y=gGEP*-1)) +
  geom_line(aes(x=datetime, y=GEPpred*-1), color = "red") +
  ylab(expression("GEP "~"("~g~C~m^{-2}~d^{-1}~")")) + xlab("Date") +
  theme_classic()

grid.arrange(a, b, ncol = 1)
```

```{r flux_reduction_estimates, echo=FALSE}
#calculate annual budgets for RF predictions and observations during salinity years
annual_budgets <- rise_years %>%
  group_by(year) %>%
  summarise(CH4yr = mean(mgCH4)*365/1000,
            CH4yr_rf = mean(CH4pred)*365/1000,
            GEPyr = mean(gGEP)*365,
            GEPyr_rf = mean(GEPpred)*365) %>%
  mutate(CH4pc = abs(CH4yr - CH4yr_rf)*100/CH4yr,
         GEPpc = abs(GEPyr - GEPyr_rf)*100/abs(GEPyr))
```

Salinity 'naive' model predictions during the high salinity period demonstrate that CH~4~ fluxes were not substantially lower than expected if the impact of salinity was not taken into account (figure 4). During 2015, annual CH~4~ flux observations were only `r annual_budgets$CH4pc[annual_budgets$year == 2015]`% below the model predictions, though during 2016, observed annual budgets were `r annual_budgets$CH4pc[annual_budgets$year == 2016]`% below the model predictions. A much larger effect was observed for *GEP*, where *GEP* was substantially below salinity 'naive' model predictions (figure 4). During 2015, annual *GEP* budgets was `r annual_budgets$GEPpc[annual_budgets$year == 2015]`% lower than model predictions, and during 2016 annual *GEP* was `r annual_budgets$GEPpc[annual_budgets$year == 2016]`% lower than model predictions. The *GEP* model explained `r max(pre_GEP$results$Rsquared)*100`% of observed variance (*r^2^*; *m~try~* = 4), and the *F~CH4~* model explained `r max(pre_CH4$results$Rsquared)*100`% of observed variance (*r^2^*; *m~try~* = 3) in the training data.

# 4. Discussion
Our study suggests that episodic salinization affecting freshwater restored wetlands disproportionately reduced *GEP* compared to CH~4~ fluxes (figure 4), which led to an overall increase in wetland GHG emissions during peak salinity [@chamberlain_soil_2018]. The dominant wetland plant species, *Typha* spp., are generally found in low salinity reaches of the San Francisco Estuary [@watson_abundance_2009], and their growth and recruitment is considerably reduced at the salinity levels observed here [@beare_cattail_1987; @glenn_effects_1995]. These large reductions in CO~2~ uptake stand in contrast to persistent CO~2~ uptake at a nearby brackish tidal marsh (-225 g C m^-2^ yr^-1^) that experienced similar salinities; however, the brackish marsh was vegetated with a more salt-tolerant plant community. Salinity levels were also within the range where suppression of CH~4~ emissions is expected in seawater, as observed by eddy covariance [@holm_ecosystem_2016] and chamber studies [@poffenbarger_salinity_2011], suggesting the driver of wetland salinization was enhanced evaporation rather than continuous saltwater intrusion that would introduce sustained sulfate concentrations. These findings suggest that GHG emissions from these restored wetlands may increase with drought-induced salinization due to small decreases in CH~4~ emissions relative to reductions in CO~2~ uptake.

Conversely, we observed strong changes in couplings (figure 1) and information transfer (figure 3) between driving processes and CH~4~ fluxes during salinization. During high salinity, couplings and information transfer from *Ta* to *F~CH4~* strengthened, while coupling and information transfer from *GEP* to *F~CH4~* declined (figures 1 and 3, respectively). Similar dynamics were not observed at the reference wetland, where *GEP*,*F~CH4~* couplings were dominant in comparison to *Ta*,*F~CH4~* across all years (figure 2). These observations, taken with our findings of small reductions in daily to annual *F~CH4~* (figure 4), suggest that either (1) microbial utilization of other wetland C substrates compensated for reduced utilization of recent photosynthates, or (2) recent photosynthates were not an important driver of CH~4~ emissions within these wetlands. Such CH~4~ flux temperature dependence is consistent with findings across a number of ecosystems and observation scales [@yvon-durocher_methane_2014]. These conclusion stands in contrast to previous eddy covariance studies from rice within the region, where *GEP* was the dominant driver of CH~4~ fluxes compared to temperature [@hatala_gross_2012; @knox_biophysical_2016]. The contrast between our findings and rice suggests that dominant biogeochemical processes may vary across ecosystem types, and caution should be taken in extrapolating a mechanistic understanding from one system to another. In a similar vein, our previous work across these restored wetlands demonstrated highly divergent ecosystem CH~4~ flux controls driven by spatially variable soil properties [@chamberlain_soil_2018].

This study also demonstrates the utility of applying information theory and machine learning approaches to understanding ecological responses *in situ*. Information theory metrics are particularly suited to resolve connectivity and causation in complex systems due to their lack of parametric assumptions and ability to resolve scale-emergent interactions [@sturtevant_identifying_2016; @larsen_disrupted_2017; @chamberlain_soil_2018; @knox_direct_2018; @rinderer_assessing_2018]. Similarly, machine learning approaches, such as random forests applied here and ANNs used elsewhere, have increasingly been applied to quantify dominant ecosystem greenhouse gas exchange controls where non-linear, complex responses are expected [@knox_biophysical_2016; @albert_climate_2017; @stocker_quantifying_2018]. All of the above approaches are generally data intensive [@ruddell_ecohydrologic_2009; @getz_wayne_m_making_2017], though large observational datasets are becoming publicly available through data sharing communities, such as FluxNet [@baldocchi_fluxnet_2001; @hampton_big_2013]. These tools provide a strong foundation for assessing connectivity and functional relationships in natural ecosystems, where ecosystem-scale experiments may be impractical or impossible. Instead, a combination of observational networks, natural experiments, and statistical approaches can be used to understand ecosystem-scale responses to environmental change.

It is important to note that these techniques are no substitute of an ecological understanding of one's system, as spurious transfer entropy has been documented across multiple studies [@rinderer_assessing_2018], often related to multivariate interactions masked in the bivariate statistic [@runge_escaping_2012]. For example, we observed no information transfer from *F~CH4~* to *Ta* (figure S5), as expected, but did observe some spurious information transfer from *F~CH4~* to *GEP* (figure S6). This is likely due to the presence of a shared driver, such as soil temperature, or unobserved processes that covary with CH~4~ production, like decomposition-driven soil priming. Multivariate approaches have been proposed to identify spurious links through conditional mutual information [@runge_escaping_2012; @runge_identifying_2015], and these techniques are likely better suited to systems where *a priori* knowledge is limited.

Our findings demonstrate dynamic controls to wetland CH~4~ emissions across a disturbance regime, where temperature controls compensate for reduced connectivity to *GEP* during salinization (figures 1 and 3). We estimate only a small reduction in annual CH~4~ budgets, relative to annual *GEP* (figure 4), suggesting that *GEP* substrate additions are not the dominant driver of CH~4~ production and emission. Instead, other substrates likely compensate for this reduction or recent photosynthates are not an important substrate in these wetlands. Rising salinity in estuarine wetlands does not necessarily lead to reductions in CH~4~ emissions, and consequently GHG budgets, suggesting potential increases in wetland GHG emissions due to salinization as water resources become more limiting in Mediterranean regions.

# Acknowledgements
This research was supported in part by the U.S. Department of Energy’s Office of Science and its funding of Ameriflux core sites (Ameriflux contract 7079856), and the California Division of Fish and Wildlife, through a contract of the California Department of Water Resources (Award 4600011240).

# References

