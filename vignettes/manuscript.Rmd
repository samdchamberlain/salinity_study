---
title: 'Dynamic ecosystem function during wetland salinization: differential effects
  on methane biogeochemistry and ecosystem productivity.'
author: Samuel D Chamberlain^1^, Elke Eichelmann^1^, Kyle S Hemes^1^, Daphne J Szutu^1^,
  Joseph G Verfaillie^1^, and Dennis D Baldocchi^1^
date: '`r Sys.Date()`'
output:
  word_document: default
  pdf_document: default
  html_document: default
fontsize: 12pt
header-includes:
- \usepackage{setspace}
- \doublespacing
- \usepackage{lineno}
- \linenumbers
- \usepackage{hyperref}
link-citations: yes
csl: ecology-letters.csl
bibliography: library.bib
---

^1^Department of Environmental Science, Policy, and Management, University of California, Berkeley, California, USA

```{r setup, include=FALSE}
#setwd to main package directory
knitr::opts_knit$set(root.dir = normalizePath("../"))
options(digits=2)

knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>")

knitr::opts_chunk$set(echo = FALSE, warning=FALSE)
```

```{r packages, message=FALSE}
# packages used
library(knitr)
library(tidyverse)
library(lubridate)
library(gridExtra)
library(scales)
library(zoo)
library(caret)
library(forecast)
library(entropy)
library(stringr)
library(wq)

# mutual info and transfer entropy functions
source("R/MI_functions.R")
source("R/TR_functions.R")
source("R/transformations.R")
source("R/signficance_tests.R")
```

# Abstract
Wetlands are expected to experience salinization with a changing climate, but the impact of this disturbance on greenhouse gas emissions (GHG) is uncertain. Understanding how disturbance affects ecosystem function requires *in situ* observations and tools to infer couplings and causation from observational data. Using eddy covariance data from a wetland experiencing salinization, we applied information theory to quantify couplings and information transfer between environmental drivers and methane (CH~4~) fluxes and used random forest models to quantify salinization-induced changes in GHG fluxes. We observed dynamic flux-driver relationships across the disturbance regime, where temperature connections strengthened during salinization and photosynthesis connections were dampened. During peak salinization, annual photosynthesis reduced 65%, whereas annual CH~4~ emissions reduced by 13%, suggesting that other substrate sources compensated for reductions in recent photosynthates. Our results demonstrate the value of applying these statistical approaches in ecological systems and suggest drought-induced salinization will increase net GHG emissions from wetlands. (150 words)

Body: ~ 4300 words

# Introduction
Peatland restoration is a commonly proposed natural climate mitigation strategy due to long-term sequestration of carbon dioxide (CO~2~) in anoxic soils [@griscom_natural_2017; @leifeld_underappreciated_2018], which also reverses large CO~2~ emissions from the drained, oxidizing peat soils [@hatala_greenhouse_2012; @knox_agricultural_2015]. From a climate mitigation perspective it is often assumed that methane (CH~4~) emissions from re-flooded landscapes are offset by carbon (C) storage over multi-century time-scales [@mitsch_wetlands_2013; @griscom_natural_2017; @leifeld_underappreciated_2018]. Despite long-term climate benefits, CH~4~ emissions should be considered when assessing the greenhouse gas (GHG) benefit of wetland restoration activities given the strength of these sustained emissions relative to CO~2~ uptake [@neubauer_moving_2015] and the observed response of surface radiative forcing to changes in global CH~4~ emissions over short (annual to seasonal) time scales [@feldman_observationally_2018]. A global network of studies, where ecosystem-scale fluxes of CO~2~ and CH~4~ can be measured *in situ* by eddy covariance [@baldocchi_fluxnet_2001], paint a less clear picture of this climate benefit, as many wetlands are net GHG sources due to CH~4~ emissions over 20 to 100 year timescales [@petrescu_uncertain_2015]. There is also a strong need to understand how wetland GHG exchange will respond to disturbance and management if the goal is to engineer wetlands with a limited climate footprint.

Salinization is a common disturbance affecting wetlands globally, where agricultural practices [@williams_anthropogenic_2001] and road salting [@kaushal_increased_2005] commonly effect inland freshwater systems, while coastal wetlands may be affected by drought or management-induced saltwater intrusion [@drexler_effect_2001; @barlow_saltwater_2010]. This is also a growing concern in arid to semi-arid regions where evaporative demands are high and precipitation/freshwater inflow rates are low [@williams_salinisation_2002; @jolly_review_2008], and salinity levels vary with regional precipitation and water demand [@enright_salinity_2009]. Wetland salinization is expected to become more common in Mediterranean regions where water resources are scarce and aridity is predicted to increase with changing climate [@iglesias_challenges_2007; @gao_increased_2008]. The effect of changing salinity on wetlands are far reaching, affecting C cycling and export [@chambers_effect_2013; @ardon_drought_2016], nutrient cycling and biogeochemistry [@morrissey_salinity_2014; @dijk_salinization_2015], and biological community composition [@nielsen_modified_2009]. In terms of GHG exchange, CH~4~ emissions will be inhibited by changing redox conditions if seawater (containing sulfate) is the main source of increasing salinity [@poffenbarger_salinity_2011]. For this reason, coastal wetlands are often the focus of restoration efforts where tidal flows can limit CH~4~ emissions [@kroeger_restoring_2017]. However, increasing salinity may increase net GHG emissions due to stress-induced reductions in photosynthesis that offset perceived benefits of reduced CH~4~ emission [@neubauer_ecosystem_2013; @krauss_component_2016]. Additionally, gross ecosystem photosynthesis (*GEP*) provides substrate for wetland CH~4~ production [@hatala_gross_2012], so interpreting responses to salinization or other disturbance requires understanding interactions across multiple C fluxes. More generally, our understanding of how wetland GHG exchange responds to disturbance and management is limited. Fluxes can vary strongly over small spatial scales due to variable soil properties [@chamberlain_soil_2018] and vegetation structure [@matthes_parsing_2014], and often exhibit substantial interannual variability due to disturbance and successional processes [@anderson_variation_2016; @wilson_multiyear_2016; @oikawa_evaluation_2017; @pugh_wetland_2018]. A better process-based understanding of wetland GHG exchange is required for a more robust assessment of the climate benefit of wetland restoration with respect to disturbance and management.

Understanding such responses can be challenging, as ecosystems are complex systems where non-linear, lagged, and feedback interactions are common [@ruddell_ecohydrologic_2009; @sturtevant_identifying_2016]. In some cases, findings from small-scale experiments may not be relevant to whole ecosystem dynamics [@schindler_dilemma_2012], which motivates quantifying dominant or causal interactions from *in situ* observations. A number of statistical approaches common to neuroscience and econometrics, yet relatively novel to ecology, are suited to this task [@rinderer_assessing_2018], and are useful for building a process-based understanding of systems for predictive modeling [@larsen_appropriate_2016; @getz_wayne_m_making_2017]. These include non-parametric information theory metrics, such as mutual information (*MI*), that can identify dominant lagged, non-linear, and non-monotic relationships commonly observed in flux time series [@sturtevant_identifying_2016; @chamberlain_soil_2018; @knox_direct_2018]. Other metrics aimed at identifying causal relationships, such as Granger causality, have been used to identify directed relationships between GHG fluxes and the critical timescales at which they occur in forest [@detto_causality_2012] and rice ecosystems [@hatala_gross_2012]. Transfer entropy (*TE*), an additional information theory metric equivalent to Granger causality under Gaussian conditions [@barnett_granger_2009], has also been applied to understand functional changes in ecohydrologic systems during drought [@ruddell_ecohydrologic_2009; @ruddell_ecohydrologic_2009-1] and how C cycling responds to restoration practices [@larsen_disrupted_2017]. These statistical methods provide a means to understand ecosystem functional changes from observational data, which is critical to predicting how systems might respond to disturbance or management.

The objectives of this study were to determine the effect of drought-induced wetland salinization on CO~2~ and CH~4~ fluxes from restored wetlands in the Sacramento-San Joaquin Delta of California, USA. We measured ecosystem-scale CO~2~ and CH~4~ fluxes by eddy covariance from a restored wetland complex that experienced a substantial rise in salinity over the course of six years and was subsequently flushed with freshwater by land managers during the seventh year. We used (1) information theory metrics to identify the how couplings and causal relationships between temperature, *GEP*, and CH~4~ fluxes varied over the course of wetland salinization, and (2) used random forest models to quantify the overall reduction in *GEP* and CH~4~ fluxes due to salinization. Understanding and predicting the response of Delta wetland GHG exchange to salinization events is important from a policy perspective, as wetland restoration in the region is funded through California's Cap-and-Trade Program [@deverel_implications_2017; @oikawa_evaluation_2017] and freshwater is projected to become an increasingly limited resource in the state's future [@vicuna_sebastian_sensitivity_2007].

# Materials and Methods
## Site Description and Flux Measurements
We measured ecosystem-scale fluxes of CO~2~, CH~4~, water (H~2~O), and energy for seven years from a restored wetland on Sherman Island in the Sacramento-San Joaquin Delta of California, USA (Ameriflux site Us-Myb; N 38.0498, W 121.7650). The wetland was restored in 2010 on a former pasture, and our measurements began at the point of initial restoration and re-flooding. The site is predominantly vegetated with cattails (*Typha* spp.) and some tules (*Schoenoplectus acutus*) and does not experience seasonal, tidal changes in salinity experienced by the adjacent Sacramento and San Joaquin rivers. The wetland's water is closed off from river sources, though managers are able to control the inflow and outflow of water to the wetland from the main river channels. We also compared findings from this site to a mature wetland reference site (Ameriflux site Us-Tw1; N 38.1074, W 121.6469) restored in 1999 that did not experience an increase in salinity across the same time period. More description of this mature reference site can be found in @miller_plant_2010 and @eichelmann_effect_2018.

Fluxes were measured continuously by eddy covariance, and were integrated over half-hour periods from the covariance of vertical wind velocity using a 3-dimensional sonic anemometer (Gill WindMaster; Gill Instruments Ltd, Lymington, Hampshire, England) and gas concentrations (CO~2~, CH~4~, and H~2~O) using open-path infrared gas analyzers (LI-7500 & LI-7700; LI-COR, Lincoln, NE, USA) measured at 20 Hz frequency. Standardized flux corrections and quality control were applied, including high-frequency data despiking, 2-D coordinate rotations, density corrections, and site-specific friction velocity (*u$^\ast$*) filtering. Data gaps in the flux time series were filled using artificial neural networks (ANNs), and net ecosystem exchange of CO~2~ (NEE) was partitioned into ER and GEP by training an ANN on nighttime CO~2~ fluxes and using this ANN to predict ER at all times. GEP was then estimated as the difference between NEE and ER. Site instrumention and descriptions are described in greater detail in [@eichelmann_effect_2018], quality control procedures are described in more detail in @knox_agricultural_2015 and @chamberlain_evaluation_2017, and gap-filling and partitioning in @baldocchi_does_2015. The partitioning methods perform well against independent soil respiration verfication methods [@oikawa_revisiting_2017]. We also measured air temperature, conductivity, among a host of other auxillary variables described in @eichelmann_effect_2018. We measured water conductivity using stainless-steel electrodes (CS547A-L; Campbell Scientific, Logan, UT, USA) and air temperature using shielded and aspirated thermistor and capacitance sensors (HMP45; Viasala, Vantaa, Finland).

## Information Theory Methods
We used mutual information (*MI*) to identify *undirected* couplings between variables and transfer entropy (*TE*) to infer *directed*, or causal, interactions between variables and the time scales at which they occur. Mutual information is used to identify the amount of information shared between two variables *X* and *Y*, or the reduction of uncertainty given knowledge of another variable, and can be described using the following equation:
$$MI_{X,Y}=H_X+H_Y-H_{X,Y}$$
where *H~X~* and *H~Y~* are marginal Shannon entropies of each variable, and *H~Y,X~* is the joint Shannon entropy of *X* and *Y*. Marginal entropies are calculated from the probability distributions of a variable *Y* as follows:
$$H_Y=-\sum_{y_t}p(y_t)log_2p(y_t)$$
And joint entropies are calculated from the joint probability distributions of variables *X* and *Y* as follows:
$$H_{X,Y}=-\sum_{x_t}\sum_{y_t}p(x_t,y_t)log_2p(x_t,y_t)$$
where *x~t~* and *y~t~* are states within the overall distribution of *X* and *Y*. We calculated *MI* for one-month blocks across the entire flux time series to quantify the change in couplings between flux variables across the salinity disturbance event. For each month, continuous variables were discretized to 10 bins of equivalent length across the range of each variable. Mutual information was then calculated for each variable pair of interest (*Ta*,*F~CH4~* & *GEP*,*F~CH4~*), and a significance threshold was determined via 100 Monte Carlo reshufflings of the independent variable (*Ta* or *GEP*). Because the reshuffled values (*MI'*) varies with the number of CH~4~ flux observations per month (Supporting Information; Fig. S1) we present *MI-MI'*, similar to @larsen_disrupted_2017, such that any values in Figs. 1 and 2 greater than zero are signficant couplings.

While *MI* identifies coupling strength [@sturtevant_identifying_2016; @chamberlain_soil_2018] between variables it does not ascribe directionality to the relationship. Transfer entropy quantifies directional information transfer, or more technically, the extent to which knowledge of a variables *X* reduced the uncertainty of the present state of *Y* given knowledge of the history of *Y* itself. If a value of *TE* is above some significance threshold (described below) it is deduced that information flows from *X* to the current state of *Y* [@ruddell_ecohydrologic_2009]. Transfer entropy can also be described by joint and marginal entropies incorporating time lags as follows [@knuth_revealing_2013; @ruddell_ecohydrologic_2009]:
$$T(X>Y, \tau) = H(X_{t-\tau}, Y_{t-1}) + H(Y_{t}, Y_{t-1}) - H(Y_{t-1}) + H(X_{t-\tau}, Y_{t}, Y_{t-1})$$
In the above formulation, we assume the immediate history of *Y* (t-1; i.e. the preceding half-hour in eddy flux time series) contributes the most information to the current state of *Y*, and we calculate *TE* across multiple lags of *X* to identify the critical timescale of interactions between variables [@ruddell_ecohydrologic_2009; @larsen_disrupted_2017]. A more in depth description of applying *TE* and *MI* to ecosystem-atmosphere flux time series can be found in @ruddell_ecohydrologic_2009, and we follow the basic protocols outlined in this work. This includes building discrete probability distributions using 10 bins for each variable as described above, transforming variables prior to *TE* calculations using a 5-day anomaly filter, and again establishing significance thresholds using Monte Carlo reshuffling of the flux time series. We calculate *TE* for information flow from *Ta* to *F~CH4~* and *GEP* to *F~CH4~*, and did so across multiple lags of the independent variable up to 60 hours to understand the dominant timescale of interactions. Similarly, we calculated significance thresholds for *TE* at each lag and used 25 reshufflings, rather than 100, due to computational demands. Calculations of transfer entropy are data intensive [@ruddell_ecohydrologic_2009], so we calculate *TE* for entire growing seasons each year (Julian day 100 to 300) similar to @sturtevant_identifying_2016 and @chamberlain_soil_2018. We present both *MI* and *TE* in their relative form, normalized by the entropy of the *Y* variable (*F~CH4~*), so the values represent reductions in the uncertainty of CH~4~ fluxes [@larsen_disrupted_2017]. All information theory calculations were conducted using R 3.3.2 [@r_citation] with the 'entropy' package and home built functions to calculate *TE* and significance thresholds available online with this manuscript (https://github.com/samdchamberlain/salinity_study).

## Determining Salinity Impacts on Annual GHG Fluxes
To quantify the reduction in *GEP* and *F~CH4~* due to salinity effects, we trained a random forest model on fluxes during years prior to the salinity rise when the wetland was fully vegetated (2012-2014) using common meteorological variables and drivers of each flux. For *GEP*, this included *Ta*, photosynthetically active radiation (*PAR*), vapor pressure deficit (*VPD*), air pressure (*PA*), and friction velocity (*u$^\ast$*), and for CH~4~ flux this included *GEP*, *Ta*, *VPD*, *PA*, and *u$^\ast$*. Random forests are an ensemble tree-based method where numerous trees are constructed using bootstrap samples from the training dataset, and the trees are averaged to generate a final prediction. For each tree, a random subset of the predictors (*m~try~*) are chosen at each tree split to reduce overfitting [@breiman_random_2001]. We used an ensemble of 500 trees, and the *m~try~* value (ranging from 2-4) was chosen by using the model formulation with the lowest root mean squared error following five-fold cross-validation [@kuhn_applied_2013]. Any missing values in the predictor data were imputed using medians. We then used the tuned random forest model to generate predictions of CH~4~ flux and *GEP* during the high salinity years (2015-2016), and quantified the effect of salnization as the difference between observed fluxes and model predictions. The model was trained on weltand fluxes prior to the salinity increase, and the predictions are therefore respresentative of salinity 'naive' ecosystem function. We only included meteorological predicitor variables that were not influenced by salinity in the model tuning process, with the exception of *GEP* in the CH~4~ flux model based on previous findings in this region [@hatala_gross_2012]. Random forest models were fit using the 'caret' [@caret] and 'randomForest' [@randomForest] packages. All additional data processing, statistical analysis, and visualization were conducted using the 'tidyverse' [@tidyverse], 'zoo' [@zoo], 'gridExtra' [@gridExtra], 'lubridate' [@lubridate], and 'scales' [@scales] packages. This manuscript is reproducible via R Markdown, and its code can be found at https://github.com/samdchamberlain/salinity_study.

# Results
```{r load_process}
#load and process wetland sites into half-hourly, daily, and annual sums
source("R/peat6_processing.R") #wetland experiencing salinity rise
source("R/peat19_processing.R") #baseline mature wetland w/o salinity rise
```

We observed a substantial increase in salinity over the course of our observation period. Salinity levels were relatively stable from 2012 through 2013, began to rise through 2014, peaked in 2016, and reduced rapidly in 2017 when site managers flushed the wetland system with freshwater (Fig. 1). Substantial interannual variability was observed in GEP and ER fluxes, where the first-year post-restoration (2012) monthly fluxes were very large in magnitude, followed by a low flux year in 2013. Methane fluxes were more stable but reduced in magnitude across the measurement period (Fig. 1). In 2015 when salinity began to rise rapidly, all fluxes were in the mid-range compared across the entire measurement period. In 2016 when salinity peaked, all late season fluxes were low compared to previous years (Fig. 1). Fluxes remained low into 2017, and we observed a strong increase in late season fluxes coincident with freshwater flushing that rapidly reduced salinity (Fig. 1).

Coupling between driver variables (*GEP* and *Ta*) and *F~CH4~* were similar in the pre-disturbance period (2012 through 2014) where maximum *MI* was observed during the growing season and were of similar magnitude for *MI~Ta,FCH4~* and *MI~GEP,FCH4~* (Fig. 2). During 2014, *MI* did not display a similar seasonality, presumabely due to a large-scale insect outbreak that affected the wetland, though a late season increase in *MI* was still observed for both *MI~Ta,FCH4~* and *MI~GEP,FCH4~*. During 2015 and 2016, the peak of the salinity disturbance, we observed a strong decoupling between *GEP* and *F~CH4~*, as well as a strengthening in the coupling between *Ta* and *F~CH4~* compared with the previous years (Fig. 2). The decoupling of *GEP* and *F~CH4~* across 2015 and 2016 is not driven by a crash in the *GEP* flux magnitude, as *GEP* magnitudes within the season were similar to previous years (Fig. 1). During the managed flushing period of 2017 when salinity levels dropped steeply, couplings between *GEP* and *F~CH4~* began to recover but were highly variable throughout the season as salinity changed (Fig. 2). These coupling dynamics are somewhat observable in monthly Kendall's tau, but the general patterns are obscured by large negative coefficients observed during winter periods (Supporting Information; Fig. S2).

```{r fig1, fig.cap = "Monthly cumulative fluxes of methane (*F~CH4~*), gross ecosystem photosynthesis (*GEP*), ecosystem respiration (*ER*), as well as mean salinity across the salinization event. The wetland was one year old and fully vegetated by 2012.", fig.width=3, fig.height=7, dpi=600}
time_series <- theme_bw() +
  theme(panel.grid.minor=element_blank(), panel.grid.major.y = element_blank(),
        axis.title.x = element_blank(), axis.title.y = element_text(size=10))

vegetated_monthly <- subset(peat6_monthly, year > 2011)
vegetated_monthly$Year <- as.factor(vegetated_monthly$year)

a <- ggplot(vegetated_monthly, aes(x=month, y=gCH4, color=Year)) +
  geom_line() +
  scale_x_continuous(breaks = seq(2, 12, by=2)) +
  ylab(expression(F[CH4]~" "~"("~g~C~m^{-2}~mn^{-1}~")")) +
  time_series + theme(legend.position = "none")

b <- ggplot(vegetated_monthly, aes(x=month, y=gGEP, color=Year)) +
  geom_line() +
  scale_x_continuous(breaks = seq(2, 12, by=2)) +
  ylab(expression("GEP "~"("~g~C~m^{-2}~mn^{-1}~")")) +
  time_series + theme(legend.position = "none")

c <- ggplot(vegetated_monthly, aes(x=month, y=gER, color=Year)) +
  geom_line() +
  scale_x_continuous(breaks = seq(2, 12, by=2)) +
  ylab(expression("ER "~"("~g~C~m^{-2}~mn^{-1}~")")) +
  time_series +
  theme(legend.margin = margin(0, 0, 0, 0),
        legend.position=c(.14, .62), legend.key.size =  unit(0.14, "in"),
        legend.text = element_text(size=8), legend.title = element_text(size=9, face = "bold")) 

d <- ggplot(vegetated_monthly, aes(x=month, y=mSal, color=Year)) +
  geom_line() +
  scale_x_continuous(breaks = seq(2, 12, by=2)) +
  ylab("Salinty (psu)") + xlab("Month") +
  theme_bw() +
  theme(panel.grid.minor=element_blank(), panel.grid.major.y = element_blank(),
        axis.title.y = element_text(size=10), legend.position = "none")

#Multiple plots aligned
iA <- ggplotGrob(a)
iB <- ggplotGrob(b)
iC <- ggplotGrob(c)
iD <- ggplotGrob(d)

maxWidth = grid::unit.pmax(iA$widths[2:5], iB$widths[2:5], iC$widths[2:5], iD$widths[2:5])
iA$widths[2:5] <- as.list(maxWidth); iB$widths[2:5] <- as.list(maxWidth); 
iC$widths[2:5] <- as.list(maxWidth); iD$widths[2:5] <- as.list(maxWidth);

grid.arrange(iA, iB, iC, iD, ncol=1)
```

```{r fig2, fig.cap="Monthly relative mutual information (*MI*; top panel) shared between *GEP* and *F~CH4~* (green) as well as *Ta* and *F~CH4~* (red) at the wetland that experienced salinization. All *MI* values are corrected using 100 Monte Carlo reshufflings of time series, such that *MI* > 0 are statistically significant at *P* < 0.05. The lines represent 3 month running means. Bottom panel displays daily mean water column salinity (psu).", fig.width=7, fig.height=5, dpi=600}

## Processing for high salinity wetland
#create a growing month stamp
peat6_all$month <- month(peat6_all$datetime)
peat6_all$m_yr <- paste(peat6_all$year, peat6_all$month, sep = "")

#create data list by month
by_month <- peat6_all %>%
  filter(year > 2011 & year < 2018) %>%
  group_by(m_yr) %>%
  nest()

#plot that needs to be dealt with later
clipped_monthly <- subset(peat6_monthly, year > 2011 & year < 2018)
clipped_monthly$date <- as.Date(clipped_monthly$datetime)
clipped_monthly$GPP_CH4_mi <- mi_timeseries(gpp_ANNnight, wm, data_list = by_month)
clipped_monthly$Tair_CH4_mi <- mi_timeseries(TA.x, wm, data_list = by_month)

# Monte Carlo significance thresholds (dont run everytime as they take a while)
sig_gpp <- conf_series(gpp_ANNnight, wm, data_list = by_month, runs = 100, alpha = 0.05)
sig_Tair <- conf_series(TA.x, wm, data_list = by_month, runs = 100, alpha = 0.05)

# Correct MI values of bias due to sample size, now anything over zero is significant at p < 0.01
clipped_monthly$TairMI_corrected <- clipped_monthly$Tair_CH4_mi - sig_Tair
clipped_monthly$gppMI_corrected <- clipped_monthly$GPP_CH4_mi - sig_gpp

a <- ggplot(clipped_monthly) +
  geom_point(aes(x = date, y = TairMI_corrected), color = "red", alpha = 0.5) +
  geom_line(aes(x = date, y = ma(TairMI_corrected, 3)), color = "red", size = 1) +
  geom_point(aes(x = date, y = gppMI_corrected), color = "dark green", alpha = 0.5) +
  geom_line(aes(x = date, y = ma(gppMI_corrected, 3)), color = "dark green", size = 1) +  
  scale_x_date(date_breaks = "1 year", labels = date_format("%Y")) +
  scale_y_continuous(limits = c(0, 0.3)) +
  ylab(expression(bolditalic(MI)~"(x,"~F[CH4]~")")) + xlab("") + ggtitle("Salinization wetland") +
  theme_bw()

b <- ggplot(subset(peat6_daily, year > 2011 & year < 2018), aes(x=as.Date(datetime), y=Sal)) +
  geom_line(color = "blue") +
  scale_y_continuous(limits = c(0, 7)) +
  scale_x_date(date_breaks = "1 year", labels = date_format("%Y")) +
  ylab("Salinity (psu)") + xlab("Year") +
  theme_bw()

#Multiple plots aligned
iA <- ggplotGrob(a)
iB <- ggplotGrob(b)

maxWidth = grid::unit.pmax(iA$widths[2:5], iB$widths[2:5])
iA$widths[2:5] <- as.list(maxWidth); iB$widths[2:5] <- as.list(maxWidth); 

grid.arrange(iA, iB, ncol=1)
```

This change in coupling dynamics across the salinity disturbance stands in contrast to the relatively stable couplings between *F~CH4~* and either *Ta* or *GEP* at a nearby wetland that did not experience salinization (Fig. 3). This wetland experienced some watertable drawdowns in 2013 and 2014 that are discussed in more detail in @sturtevant_identifying_2016, but regardless, we observed couplings of similar magnitude for *MI~Ta,FCH4~* and *MI~GEP,FCH4~* across all years (Fig. 3). Most importantly, we did no observe a similar decoupling of *F~CH4~* and *GEP* during 2015 and 2016 when salinity levels did not increase at this wetland site. Flux magnitudes were often similar magnitude or larger at this wetland complex compared with the site that experienced salinization, particularly during the high salinity periods when *GEP* decreased at wetland experiencing salinization (Supporting Information; Fig. S3).

```{r fig3, fig.cap="Monthly relative mutual information (*MI*; top panel) shared between *GEP* and *F~CH4~* (green) as well as *Ta* and *F~CH4~* (red) at the reference wetland with no salinity increase. All *MI* values are corrected using 100 Monte Carlo reshufflings of time series, such that *MI* > 0 are statistically significant at *P* < 0.05. Only positive *MI* are shown, and the lines represent 3 month running means. Bottom panel displays daily mean water column salinity (psu).", fig.width=7, fig.height=5, dpi=600}

#create a growing month stamp
peat19_all$month <- month(peat19_all$datetime)
peat19_all$m_yr <- paste(peat19_all$year, peat19_all$month, sep = "")

#create data list by month
by_month <- peat19_all %>%
  filter(year > 2012 & year < 2018) %>%
  group_by(m_yr) %>%
  nest()

#plot that needs to be dealt with later
clipped_monthly <- subset(peat19_monthly, year > 2012 & year < 2018)
clipped_monthly$date <- as.Date(clipped_monthly$datetime)
clipped_monthly$GPP_CH4_mi <- mi_timeseries(gpp_ANNnight, wm, data_list = by_month)
clipped_monthly$Tair_CH4_mi <- mi_timeseries(TA.x, wm, data_list = by_month)

# Monte Carlo significance thresholds (dont run everytime as they take a while)
sig_gpp <- conf_series(gpp_ANNnight, wm, data_list = by_month, runs = 100, alpha = 0.05)
sig_Tair <- conf_series(TA.x, wm, data_list = by_month, runs = 100, alpha = 0.05)

# clipped_monthly$Tair_ma <- na.ma(ma(clipped_monthly$Tair_ma, 3))
# clipped_monthly$GPP_ma <- na.ma(ma(clipped_monthly$GPP_ma, 3))

# Correct MI values of bias due to sample size, now anything over zero is significant at p < 0.01
clipped_monthly$TairMI_corrected <- clipped_monthly$Tair_CH4_mi - sig_Tair
clipped_monthly$gppMI_corrected <- clipped_monthly$GPP_CH4_mi - sig_gpp

a <- ggplot(clipped_monthly) +
  geom_point(aes(x = date, y = TairMI_corrected), color = "red", alpha = 0.5) +
  geom_line(aes(x = date, y = ma(TairMI_corrected, 3)), color = "red", size = 1) +
  geom_point(aes(x = date, y = gppMI_corrected), color = "dark green", alpha = 0.5) +
  geom_line(aes(x = date, y = ma(gppMI_corrected, 3)), color = "dark green", size = 1) +  
  scale_x_date(date_breaks = "1 year", labels = date_format("%Y")) +
  scale_y_continuous(limits = c(0, 0.3)) +
  ylab(expression(bolditalic(MI)~"(x,"~F[CH4]~")")) + xlab("") + ggtitle("Baseline wetland") +
  theme_bw()

b <- ggplot(subset(peat19_daily, year > 2012 & year < 2018), aes(x=as.Date(datetime), y=Sal)) +
  geom_line(color = "blue") +
  scale_x_date(date_breaks = "1 year", labels = date_format("%Y")) +
  scale_y_continuous(limits = c(0, 7)) +
  ylab("Salinity (psu)") + xlab("Year") +
  theme_bw()
  
#Multiple plots aligned
iA <- ggplotGrob(a)
iB <- ggplotGrob(b)

maxWidth = grid::unit.pmax(iA$widths[2:5], iB$widths[2:5])
iA$widths[2:5] <- as.list(maxWidth); iB$widths[2:5] <- as.list(maxWidth); 

grid.arrange(iA, iB, ncol=1)
```

We observe a similar transition in the hierarchy of coupling between the low salinity period (2012-2013) and the high salinity period (2015-2016) in transfer entropy, interpreted as information transfer, from *GEP*/*Ta* to *F~CH4~* (Fig. 4). During the low salinity period, we observed similar magnitude information transfers from *GEP* to *F~CH4~* and from *Ta* to *F~CH4~*. Here, we observed significant information transfers from *GEP* to *F~CH4~* between 0-12 hour time lags and over similar lag periods from the previous two days (Fig. 4). These transfers were still observable during 2015, though over condensed lag periods. By 2016 during peak salinity, only weak significant information transfers from *GEP* to *F~CH4~* were observed at 0-3 hour lags and a small window near 48 hours (Fig. 4). We observed a very different dynamic in information transfer from *Ta* to *F~CH4~* that mirrors our *MI* observations, where *TE*(*Ta* > *F~CH4~*) was of similar magnitude to *TE*(*GEP* > *F~CH4~*) during the low salinity years (2012 & 2013), and information transfer from *Ta* to *F~CH4~* strengthened during the high salinity periods in 2015 and 2016 (Fig. 4). Under most conditions, *Ta* at time lags up to ~30 hours affected current CH~4~ flux rates, with additional significant transfers around 48 hours (Fig. 4). Transfer entropy from 2014 and 2017 was not evaluated in this analysis because the wetland's experienced an insect outbreak and flushing disturbance, respectively, and obscure our ability to evaluate the effect of salinization alone. We observed no significant transfer of information from *F~CH4~* to *Ta* (Supporting Information; Fig. S4), as expected since biological trace gas fluxes should not affect regional meteorological conditions.

```{r fig4, fig.cap="Relative transfer entropy (***TE***) from (top panel) half-hourly *GEP* to *F~CH4~* and (bottom panel) *Ta* to *F~CH4~* over the growing season during years of low salinity (2012-2013) and high salinity (2015-2016). The red line represents a significance threshold (*P* < 0.05) based on Monte Carlo reshuffling of the time series. Other lines represented ***TE*** at various lags of *GEP* or *Ta*, and the color scale shows mean salinity (psu) during the respective year. Years 2014 and 2017 are omitted from analysis because other disturbance events affected wetlands processes and confound analyses.", fig.height=4, fig.width=7.5, dpi=600}

#apply anomaly filter
anom_data <- peat6_all %>%
  arrange(year, time) %>%
  mutate(CH4_anom = anom_filter(wm_gf),
         TA_anom = anom_filter(TA.x),
         GPP_anom = anom_filter(gpp_ANNnight))

anom_data <- arrange(anom_data, datetime)
anom_data$CH4na_anom <- ifelse(is.na(anom_data$wm), NA, anom_data$CH4_anom) # re-insert missing values

# Focus only on high v. low salinity years without additional disturbance
# other disturbance includes the 2014 insect outbreak and 2017 flushing events
anom_data <- subset(anom_data, year %in% c(2012, 2013, 2015, 2016))

#create data list by annual growing season
by_year <- anom_data %>%
  filter(DOY > 100 & DOY < 300) %>%
  group_by(year) %>%
  nest()

#calculate lagged transfer entropy time series (up to 2 day lag at half-hourly timestep)
# for GPP -> CH4
tr_wm_gpp <- tr_timeseries(GPP_anom, CH4na_anom, data_list = by_year, type = "observed", 
                           lags = 120, bins = 10, normalize = T)

mc_wm_gpp <- tr_timeseries(GPP_anom, CH4na_anom, data_list = by_year, type = "shuffled", 
                           lags = 120, bins = 10, runs = 25, alpha = 0.05, normalize = T)
# for TA -> CH4
tr_wm_ta <- tr_timeseries(TA_anom, CH4na_anom, data_list = by_year, type = "observed", 
                           lags = 120, bins = 10, normalize = T)

mc_wm_ta <- tr_timeseries(TA_anom, CH4na_anom, data_list = by_year, type = "shuffled", 
                           lags = 120, bins = 10, runs = 25, alpha = 0.05, normalize = T)

#unlist data to tidy dataframe
gpp.wm_df <- tidy_list(tr_wm_gpp); gpp.wm_shuf <- tidy_list(mc_wm_gpp)
ta.wm_df <- tidy_list(tr_wm_ta); ta.wm_shuf <- tidy_list(mc_wm_ta)

#add mean annual conductivity to dataframes by year
mean_sal <- anom_data %>%
  filter(DOY > 100 & DOY < 300) %>%
  group_by(year) %>%
  summarise(`Sal. (psu)` = mean(sal, na.rm = T))

gpp.wm_df <- merge(gpp.wm_df, mean_sal, all.x = T) 
ta.wm_df <- merge(ta.wm_df, mean_sal, all.x = T) 

a <- ggplot() +
  geom_line(data = gpp.wm_df, aes(x = hour, y = tr, color = `Sal. (psu)`)) +
  geom_line(data = gpp.wm_shuf, aes(x = hour, y = tr), color = "red") +
  facet_wrap(~year, nrow = 1) +
  scale_x_continuous(breaks = seq(0, 60, by = 12)) +
  scale_y_continuous(limits = c(0.005, 0.04)) +
  xlab("") + ylab(expression(bolditalic(TE)~"("~GEP %->% F[CH4]~")")) +
  theme(legend.margin = margin(0, 0, 0, 0),
        legend.position=c(.82, .7), legend.key.size =  unit(0.1, "in"),
        legend.text = element_text(size=8), legend.title = element_text(size=8.5, face = "bold"),
        legend.background = element_rect(fill = "transparent"))

b <- ggplot() +
  geom_line(data = ta.wm_df, aes(x = hour, y = tr, color = `Sal. (psu)`)) +
  geom_line(data = ta.wm_shuf, aes(x = hour, y = tr), color = "red") +
  facet_wrap(~year, nrow = 1) +
  scale_y_continuous(limits = c(0.005, 0.04)) +
  scale_x_continuous(breaks = seq(0, 60, by = 12)) +
  xlab("Lag (hours)") + ylab(expression(bolditalic(TE)~"("~T[a] %->% F[CH4]~")")) +
  theme(legend.position = "none")

#Multiple plots aligned
iA <- ggplotGrob(a)
iB <- ggplotGrob(b)

maxWidth = grid::unit.pmax(iA$widths[2:5], iB$widths[2:5])
iA$widths[2:5] <- as.list(maxWidth); iB$widths[2:5] <- as.list(maxWidth); 

grid.arrange(iA, iB, ncol=1)
```

```{r pre_salinity_models, message=FALSE, warnign=FALSE}
# train nn model on pre-salinity rise years and use to calculate reduction in component fluxes 
pre_rise <- peat6_daily %>%
  filter(year > 2011 & year < 2015) %>%
  select(mgCH4, gGEP, gER, mET, PAR, H, Tair, Tw, Ts, mVPD, PA, u., Rain, WTD)

set.seed(1000)
# Random forest model for GEP trained pre-salinity rise
pre_GEP <- train(gGEP ~ Tair + PAR + mVPD + PA + u., data = pre_rise,
                      method = "rf",
                      trControl = trainControl(method = "cv", number = 5),
                      preProcess = c("medianImpute"),
                      tuneGrid = expand.grid(.mtry = c(2, 3, 4)),
                      na.action = na.pass)

set.seed(2000)
# Random forest model for FCH4 trained pre-salinity rise
pre_CH4 <- train(mgCH4 ~ gGEP + Tair + mVPD + PA + u., data = pre_rise,
                      method = "rf",
                      trControl = trainControl(method = "cv", number = 5),
                      preProcess = c("medianImpute"),
                      ntree = 1000,
                      tuneGrid = expand.grid(.mtry = c(2, 3, 4)),
                      na.action = na.pass)

# # generate predictions for high salinity years for GEP and FCH4
# pre_rise$GEPpred <- predict.train(pre_GEP, pre_rise, na.action = na.pass)
# pre_rise$CH4pred <- predict.train(pre_CH4, pre_rise, na.action = na.pass)
# 
# # save ob v. pred summary statistics
# GEPregr <- summary(lm(gGEP ~ GEPpred, data = pre_rise))
# CH4regr <- summary(lm(mgCH4 ~ CH4pred, data = pre_rise))
# 
# a <- ggplot(pre_rise, aes(x = CH4pred, y = mgCH4)) +
#   geom_point(alpha = 0.25) +
#   geom_abline(intercept = 0, slope = 1) +
#   xlab(expression(F[CH4-Pred.]~" (mg C"~m^{-2}~d^{-1}~")")) +
#   ylab(expression(F[CH4-Obs.]~" (mg C"~m^{-2}~d^{-1}~")")) +
#   ggtitle("Pre-salinity rise (2012-2014)")
# 
# b <- ggplot(pre_rise, aes(x = GEPpred*-1, y = gGEP*-1)) +
#   geom_point(alpha = 0.25) +
#   geom_abline(intercept = 0, slope = 1) +
#   ylab(expression(GEP[Obs.]~"("~g~C~m^{-2}~d^{-1}~")")) +
#   xlab(expression(GEP[Pred.]~"("~g~C~m^{-2}~d^{-1}~")"))
# 
# grid.arrange(a, b, ncol = 1)
```

```{r fig5, fig.cap="Daily observed (black) and modeled (red) methane flux (*F~CH4~*; top panel) and gross ecosystem photosynthesis (*GEP*; bottom panel) during the high salinity period from 2015 through 2016. Model predictions were made using random forest models trained on data collected in previous years (2012-2014) when salinity levels were low.", fig.width=7.5, fig.height=4, dpi=600}
# extract data to make predictions on the salinity rise years
rise_years <- peat6_daily %>%
  filter(year > 2014 & year < 2017) %>%
  select(datetime, year, mgCH4, gGEP, gER, mET, PAR, H, Tair, Tw, Ts, mVPD, PA, u., Rain, WTD)

# generate predictions for high salinity years for GEP and FCH4
rise_years$GEPpred <- predict.train(pre_GEP, rise_years, na.action = na.pass)
rise_years$CH4pred <- predict.train(pre_CH4, rise_years, na.action = na.pass)

#plotting all the measures
a <- ggplot(rise_years) +
  geom_line(aes(x=datetime, y=mgCH4)) +
  geom_line(aes(x=datetime, y=CH4pred), color = "red") +
  ylab(expression(F[CH4]~" (mg C"~m^{-2}~d^{-1}~")")) + xlab("") +
  ggtitle("High salinity period (2015-2016)") +
  theme_classic()

b <- ggplot(rise_years) +
  geom_line(aes(x=datetime, y=gGEP*-1)) +
  geom_line(aes(x=datetime, y=GEPpred*-1), color = "red") +
  ylab(expression("GEP "~"("~g~C~m^{-2}~d^{-1}~")")) + xlab("Date") +
  theme_classic()

grid.arrange(a, b, ncol = 1)
```

```{r flux_reduction_estimates, echo=FALSE}
#calculate annual budgets for RF predictions and observations during salinity years
annual_budgets <- rise_years %>%
  group_by(year) %>%
  summarise(CH4yr = mean(mgCH4)*365/1000,
            CH4yr_rf = mean(CH4pred)*365/1000,
            GEPyr = mean(gGEP)*365,
            GEPyr_rf = mean(GEPpred)*365) %>%
  mutate(CH4pc = (CH4yr - CH4yr_rf)*100/CH4yr,
         GEPpc = (GEPyr - GEPyr_rf)*100/GEPyr)
```

Finally, we trained random forest models on years of data prior to peak salinization (2012-2014) to estimate to the overall reduction in *GEP* and *F~CH4~* during the salinization period. As stated previously, both models were fit using 5-fold cross-validation where the random forest *m~try~* was chosen in the process. During cross-validation, the final *GEP* model explained `r max(pre_GEP$results$Rsquared)*100`% of observed variance (*r^2^*; *m~try~* = 4), and the final *F~CH4~* model explained `r max(pre_CH4$results$Rsquared)*100`% of observed variance (*r^2^*; *m~try~* = 3).

Salinity 'naive' model predictions during the high salinity period demonstrate that CH~4~ fluxes were not substantially lower than expected if the impact of salinity was not taken into account (Fig. 5). During 2015, annual CH~4~ flux observations were only `r annual_budgets$CH4pc[annual_budgets$year == 2015]`% below the model predictions, though during 2016, observed annual budgets were `r annual_budgets$CH4pc[annual_budgets$year == 2016]`% below the model predictions. A much larger effect was observed for *GEP*, where observed *GEP* was substantially below the model predictions not accounting for salinity effects, particularly during 2016 when salinity levels were highest (Fig. 5). During 2015, observed annual *GEP* budgets were `r annual_budgets$GEPpc[annual_budgets$year == 2015]`% lower than predictions, and during 2016 annual *GEP* observations were `r annual_budgets$GEPpc[annual_budgets$year == 2016]`% lower than predictions assuming no effect of salinity. This analysis demonstrates the disproportionate effect of wetland salinization on *GEP* rather than CH~4~ emissions.

# Discussion
Our analysis suggests that salinization affecting restored wetlands in the Sacramento-San Joaquin Delta disproportionately reduces wetland *GEP* compared to CH~4~ fluxes (Fig. 5), which led to an overall increase in wetland GHG emissions during the period of peak salinity in 2016 [@chamberlain_soil_2018]. The peak salinity this wetland experienced was well within the range where suppression of CH~4~ emissions is expected in the presence of sulphate in seawater, as observed by eddy covariance [@holm_ecosystem_2016] and chamber studies [@poffenbarger_salinity_2011], suggesting the the driver of wetland salinization was enhanced evaporation over the course of the drought rather than saltwater intrusion from the nearby estruary that would introduce high levels of sulphate. These findings suggest that net GHG emissions may increase with drought-induced wetland salinization in semi-arid to arid climates due to small decreases in CH~4~ emissions relative to the larger reductions in CO~2~ uptake.

Though we observed relatively small decreases in CH~4~ emissions during the salinization period (Fig. 5), we observed strong changes in couplings (Fig. 2) and information transfer (Fig. 4) between driving processes (*Ta* and *GEP*) and CH~4~ fluxes across the disturbance period. During the high salinity period (2015-2016), couplings (*MI*) and information transfer (*TE*) from *Ta* to *F~CH4~* strengthened (Fig. 2 and 4, respectively), and conversely, coupling and information transfer from *GEP* to *F~CH4~* declined (Fig. 2 and 4, respectively). Similar dynamics were not observed in comparison to a reference wetland that did not experience salinity increases, where *GEP*,*F~CH4~* couplings were dominant in comparison to *Ta*,*F~CH4~* across all years (Fig. 3). These observations, taken with our findings of small reductions in daily to annual *F~CH4~* (Fig. 5), suggest that either (1) microbial utilization of other weltand C substrates compenstated for reduced utilization of recent photosynthates during salinization, or (2) recent photosynthates were not an important driver of CH~4~ production and emissions within these wetlands. These conclusion stands in contrast to previous eddy covariance studies conducted on rice paddies within this same region, where it was found that *GEP* was the dominant driver of CH~4~ fluxes compared to temperature [@hatala_gross_2012; @knox_biophysical_2016]. The contrast between our findings and those from rice suggests that dominant biogeochemical processes can vary widely across ecosystem types and caution should be taken in extrapolating a mechanistic understanding from one system to another. In a similar vein, our previously work across these restored wetlands demonstrated divergent ecosystem CH~4~ flux controls driven by spatially variable soil properties across the region [@chamberlain_soil_2018].

Our study also demonstrates the utility of applying information theory and machine learning approaches to understanding ecological responses to disturbance *in situ*. Information theory metrics are particulary suited to resolve connectivity and causation in complex systems due to lack of parametric assumptions [@rinderer_assessing_2018], and their ability to resolve scale-emergent interactions [@sturtevant_identifying_2016; @larsen_disrupted_2017; @chamberlain_soil_2018; @knox_direct_2018]. In a similar vein, popular machine learning approaches, such as random forests applied here and ANNs used elsewhere, have recently been applied to quantify dominant ecosystem greenhouse gas exchange controls where non-linear, complex responses are expected [@knox_biophysical_2016; @albert_climate_2017; @stocker_quantifying_2018]. All of the above approaches are generally data intensive [@ruddell_ecohydrologic_2009; @getz_wayne_m_making_2017], though continuous observational data is becoming increasingly publicly available through data sharing communities, such as FluxNet and other ecological networks [@baldocchi_fluxnet_2001; @hampton_big_2013]. These tools provide a strong foundation for assessing connectivity and causal inference in natural ecosystems, where large-scale experiements may be impractical to impossible.

It is important to note that these techniques are not a subsitute of a ecological understanding of one's study system, as spurious transfer entropy has been documented across multiple studies [@rinderer_assessing_2018], often related to multivariate interactions masked in the bivariate transfer entropy statistic [@runge_escaping_2012]. For example, we observed no information transfer from *F~CH4~* to *Ta*, as expected, but did observe some spurious information transfer from *F~CH4~* to *GEP* that was not expected (Supporting Information, Fig. S4). This is likely due to the presence of an unobserved driver that influences both variables, such as soil temperature or decomposition-driven soil priming. Multivariate analyses have been proposed to identify spurious links through conditional mutual information [@runge_escaping_2012; @runge_identifying_2015], and these techniques are likely better suited to systems where *a priori* knowledge of controls may be more limited.

Overall, our findings demonstrate dynamic controls to wetland CH~4~ emissions across a distrubance regime, where temperature controls compensate for reduced connectivity to *GEP* during salinization (Figs. 2 and 4) and wetland producivity reduced substantially during periods of peak salinity (Fig. 5). We estimate only a small reduction in annual CH~4~ budgets, relative to annual *GEP*, suggesting that *GEP* substrate additions are not the dominant driver of CH~4~ production and emission. Instead, other substrates likely compensate for this reduction or recent photosynthates are not a dominant substrate in these wetland ecosystems. Our work also demonstrates that rising salinity in coastal systems does not neccesarily lead to reductions in CH~4~ emissions, and consequently GHG budgets, suggesting potential increases in wetland GHG emissions due to salinization as water resources become more limiting in arid to Mediterranean regions.

# Acknowledgements
This research was supported in part by the U.S. Department of Energyâ€™s Office of Science and its funding of Ameriflux core sites (Ameriflux contract 7079856), and the California Division of Fish and Wildlife, through a contract of the California Department of Water Resources (Award 4600011240).

# References

