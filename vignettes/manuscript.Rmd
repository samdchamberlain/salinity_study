---
title: "Salinity study"
author: Samuel D Chamberlain^1^, Elke Eichelmann^1^, Kyle S Hemes^1^, Daphne J Szutu^1^,
  Joseph G Verfaillie^1^, and Dennis D Baldocchi^1^
date: '`r Sys.Date()`'
output:
  html_document: default
  pdf_document: default
  word_document: default
link-citations: yes
header-includes:
- \usepackage{setspace}
- \doublespacing
- \usepackage{lineno}
- \linenumbers
- \usepackage{hyperref}
fontsize: 12pt
---

^1^Department of Environmental Science, Policy, and Management, University of California, Berkeley, California, USA

```{r setup, include=FALSE}
#setwd to main package directory
knitr::opts_knit$set(root.dir = normalizePath("../"))
options(digits=2)

knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>")

knitr::opts_chunk$set(echo = FALSE, warning=FALSE)
```

```{r packages, message=FALSE}
library(knitr)
library(tidyverse)
library(lubridate)
library(gridExtra)
library(scales)
library(zoo)
library(ggpubr)
library(caret)
library(modelr)
library(forecast)
library(entropy)
library(stringr)
```

# Abstract

# Introduction
Restoration of drained peatlands to wetlands is an attractive natural climate mitigation strategy proposed due to long-term sequestration of carbon dioxide (CO~2~) in anoxic soils [@griscom_natural_2017; @leifeld_underappreciated_2018], where wetland methane (CH~4~) emissions are often assumed to be offset by carbon (C) storage over multi-century time-scales [@mitsch_wetlands_2013]. Despite long-term climate benefits, CH~4~ emissions should be considered when assessing the greenhouse gas (GHG) benefit of wetland restoration activities given the strength of these sustained emissions relative to CO~2~ uptake [@neubauer_moving_2015] and the observed response of surface radiative forcing to changes in global CH~4~ emissions over short (annual to seasonal) time scales [@feldman_observationally_2018]. Given such concerns related to wetland CH~4~ emissions, coastal weltands are often the focus of restoration efforts where CH~4~ production and emissions are limited in the presence of sulphate in seawater [@poffenbarger_salinity_2011; @kroeger_restoring_2017]. However, ecosystem-scale observational studies of wetland GHG exchange paint a less clear picture of this climate benefit, where brackish coastal marshes may have higher GHG emissions than their freshwater counterparts [@krauss_component_2016], wetland GHG exchange can vary strongly over small spatial scales due to variable soil properties [@chamberlain_soil_2018], and restored wetland GHG balances can exhibit substantial interannual variability due to disturbance events and successional development [@wilson_multiyear_2016; @oikawa_evaluation_2017; @pugh_wetland_2018; ADD MORE CITATIONS]. A better functional understanding wetland GHG exchange and their response to disturbance and management is required for a more robust assessment of wetland restoration-based climate mitigation practices.

Salinization is a common disturbance affecting wetlands globally, where inland freshwater systems are becoming more saline due to agricultural practices [@williams_anthropogenic_2001] and road salting [@kaushal_increased_2005], and coastal ecosystems may be affected by management or drought-induced saltwater intrusion [@drexler_effect_2001; @barlow_saltwater_2010]. Salinization is also a major concern in arid to semi-arid regions where evaporative demand is high and precipitation/freshwawter inflow rates are low [@williams_salinisation_2002; @jolly_review_2008]. These issues are of growing concern in Mediterranean climates where water resources are scarce and aridity is expected to increase with changing climate [@iglesias_challenges_2007; @gao_increased_2008], and salinity levels are known to vary with regional precipitation and water demand [@enright_salinity_2009]. The effect of changing salinity on wetlands are far reaching, affecting C cycling and export [@chambers_effect_2013; @ardon_drought_2016], nutrient cycling and biogeochemistry [@morrissey_salinity_2014; @dijk_salinization_2015], as well as wetland biota [@nielsen_modified_2009]. If seawater is the main source of rising salinity CH~4~ production is also inhibited and will repress CH~4~ emissions from ecosystems [@poffenbarger_salinity_2011]; however, this climate benefit of reduced CH~4~ emissions may be offset by similar reductions in CO~2~ uptake as the wetlands experience increasing stress that reduced GEP [@neubauer_ecosystem_2013; @krauss_component_2016]. Additionally, GEP drives wetland CH~4~ flux via substrate addition [@hatala_gross_2012], so interpreting and predicting responses to salinization or other disturbance requires quantifying interactive effects across multiple GHG exchanges.

Understanding or predicting ecosystem-scale responses to disturbance events can be challenging where non-linear, lagged interactions and feedbacks are common [@ruddell_ecohydrologic_2009; @sturtevant_identifying_2016], and findings from small-scale experiments may not be relevant to whole ecosystem dynamics [@schindler_dilemma_2012]. Understanding critical interactions and causal relationships is neccesary to imrpove predictions of ecosystem reponses to disturbance, and a number of statistical approaches common to neuroscience and econometrics, yet relatively novel to ecology [@rinderer_assessing_2018], allow us to better understand dominant interactions in complex systems to construct appropriate ecosystem models [@larsen_appropriate_2016; @getz_wayne_m_making_2017]. Mutual Information (MI), a non-parametric approach to describing the coupling between variables, has been particularly useful to identifying dominant relationships in wetland GHG exchange where cross-scale or non-linear relationships are dominant [@sturtevant_identifying_2016; @chamberlain_soil_2018; @knox_direct_2018]. Other metrics aimed at identifying causal relationships, such as Granger causality, have been used to identify causal relationships between GHG fluxes forest ecosystems [@detto_causality_2012], causal links between gross ecosystem photosynthesis (GEP) and CH~4~ fluxes in rice [@hatala_gross_2012] and the timescales at which these interactions are dominant. Tranfer entropy (TE) is a non-parametric information theory-based metric, equivalent to Granger causality under Gaussian conditions [@barnett_granger_2009], that has been applied succesfully to understand functional changes in ecohydrologic systems during drought [@ruddell_ecohydrologic_2009; @ruddell_ecohydrologic_2009-1] and how C cycling responds to restoration practices [@larsen_disrupted_2017]. These metrics provide a means to better understand functional changes across disturbance events, which is critical to improving our understanding of how restored systems might respond to management or disturbance.

Objectives go here.....

# Materials and Methods

# Results
## Salinity effects
```{r load_process}
#load and process wetland sites into half-hourly, daily, and annual sums
source("R/peat6_processing.R") #wetland experiencing salinity rise
source("R/peat19_processing.R") #baseline mature wetland w/o salinity rise
```

```{r fig1, fig.height = 8, fig.width = 7}
peat6_sub <- select(peat6_daily, -starts_with("DO"), -starts_with("CO", ignore.case = F))

both_sites <- rbind(peat19_daily, peat6_sub)

a <- ggplot(subset(both_sites, year > 2013), aes(x=datetime, y=mgCH4, color=site)) +
  geom_point(size = 0.5)

b <- ggplot(subset(both_sites, year > 2013), aes(x=datetime, y=gCO2, color=site)) +
  geom_point(size = 0.5)

c <- ggplot(subset(both_sites, year > 2013)) +
  geom_line(aes(x=datetime, y=gER, color=site)) #+
  #geom_line(aes(x=datetime, y=gGEP, color=site))

d <- ggplot(subset(both_sites, year > 2013), aes(x=datetime, y=Tair, color=site)) +
  geom_line()

grid.arrange(a, b, c, d, ncol=1)
```

```{r fig2, fig.height=7, fig.width=3.5}
#Average monthly fluxes prior to salinity peak in 2016 
MBav <- subset(peat6_monthly, year > 2012 & year < 2016) %>%
  group_by(month) %>%
  summarise(CH4 = mean(gCH4),
            sdCH4 = 1.96*sd(gCH4)/sqrt(length(gCH4)),
            NEE = mean(gNEE),
            sdNEE = 1.96*sd(gNEE)/sqrt(length(gNEE)),
            ER = mean(gER),
            sdER = 1.96*sd(gER)/sqrt(length(gER)),
            GEP = mean(gGEP),
            sdGEP = 1.96*sd(gGEP)/sqrt(length(gGEP)),
            n = length(gCH4))

#Mean conductivity on Twitchell Island without salinity rise
Tw_av <- rbind(peat19_monthly, peat6_monthly) %>%
  group_by(month) %>%
  summarise(cond = mean(mCond, na.rm=T),
            sd.cond = 1.96*sd(mCond, na.rm=T)/sqrt(length(mCond)))


# plot theme
time_series <- theme_bw() +
  theme(panel.grid.minor=element_blank(), panel.grid.major.x = element_blank(),
        axis.title.x = element_blank(), axis.title.y = element_text(size=9))

# four panels
a <- ggplot() +
  geom_ribbon(data=MBav, aes(x=month, ymin=CH4-sdCH4, ymax=CH4+sdCH4), fill="light grey") +
  geom_line(data=MBav, aes(x=month, y=CH4)) +
  geom_line(data=subset(peat6_monthly, year > 2014), aes(x=month, y=gCH4, color=factor(year))) +
  scale_x_continuous(name="Month", breaks=seq(0,12,2)) +
  ylab(expression(F[CH4]~" (g C"~m^{-2}~mo^{-1}~")")) + 
  annotate("text", x=Inf, y=Inf, label="a ", vjust=1, hjust=1, fontface = "bold") +
  time_series + 
  theme(legend.title=element_blank(), legend.margin = margin(0, 0, 0, 0),
        legend.text = element_text(size=8), legend.position=c(.15, .75),
        legend.background = element_rect(fill = "transparent"))

b <- ggplot() +
  geom_ribbon(data=MBav, aes(x=month, ymin=ER-sdER, ymax=ER+sdER), fill="light grey") +
  geom_line(data=MBav, aes(x=month, y=ER)) +
  geom_line(data=subset(peat6_monthly, year > 2014), aes(x=month, y=gER, color=factor(year))) +
  ylab(expression("ER (g C"~m^{-2}~mo^{-1}~")")) + 
  annotate("text", x=Inf, y=Inf, label="b ", vjust=1, hjust=1,fontface = "bold") +
  scale_x_continuous(name="Month", breaks=seq(0,12,2)) +
  time_series + theme(legend.position = "none")

c <- ggplot() +
  geom_ribbon(data=MBav, aes(x=month, ymin=GEP-sdGEP, ymax=GEP+sdGEP), fill="light grey") +
  geom_line(data=MBav, aes(x=month, y=GEP)) +
  geom_line(data=subset(peat6_monthly, year > 2014), aes(x=month, y=gGEP, color=factor(year))) +
  ylab(expression("GEP (g C"~m^{-2}~mo^{-1}~")")) + 
  annotate("text", x=Inf, y=Inf, label="c ", vjust=1, hjust=1, fontface = "bold") +
  scale_x_continuous(name="Month", breaks=seq(0,12,2)) +
  time_series + theme(legend.position = "none")

d <- ggplot() +
  geom_ribbon(data=Tw_av, aes(x=month, ymin=cond-sd.cond, ymax=cond+sd.cond), fill="light grey") +
  geom_line(data=Tw_av, aes(x=month, y=cond)) +
  geom_line(data=subset(peat6_monthly, year > 2014), aes(x=month, y=mCond, color=factor(year))) +
  ylab("Conductivity (mS)")  + 
  annotate("text", x=Inf, y=Inf, label="d ", vjust=1, hjust=1, fontface = "bold") +
  scale_x_continuous(name="Month", breaks=seq(0,12,2)) +
  time_series + theme(legend.position = "none")

#Multiple plots aligned
g1 <- ggplotGrob(a)
g2 <- ggplotGrob(b)
g3 <- ggplotGrob(c)
g4 <- ggplotGrob(d)

grid.arrange(g1, g2, g3, g4, ncol = 1)
```

## Connectivity across time

```{r pca, echo = F}
subset <- peat6_daily %>%
  ungroup() %>%
  select(mgCH4, gGEP, mET, H, Tair, mVPD, u., Rain, WTD, Ts, Tw, PA, gER, Cond)

pca_test <- preProcess(subset, method = c("medianImpute"))
out_sub <- predict(pca_test, subset)

test <- prcomp(out_sub, scale. = T)

biplot(test)
```

```{r entropy_analysis_peat, fig.cap="Monthly relative mutual information (MI; top panel) shared between GEP and F~CH4~ (green line) as well as T~a~ and F~CH4~ (red line). All MI values are corrected for bias due to varied sample size using Monte Carlo reshuffling of time series such that MI = 0 represents the threshold of statistical significance (*P* < 0.05). Bottom panel displays daily mean water column conductivity (mS).", fig.width=7, fig.height=5, dpi=600}
source("R/MI_functions.R")
source("R/signficance_tests.R")

#create a growing month stamp
peat6_all$month <- month(peat6_all$datetime)
peat6_all$m_yr <- paste(peat6_all$year, peat6_all$month, sep = "")

#shuffle data for comparison w/ monthly gap magnitude retained
peat6_all <- peat6_all %>%
  group_by(month) %>%
  mutate(H_shuf = sample(TA.x, length(TA.x), replace = F),
         G_shuf = sample(gpp_ANNnight, length(gpp_ANNnight), replace = F),
         wm_shuf = sample(wm, length(wm), replace = F))

#create data list by month
by_month <- peat6_all %>%
  filter(year > 2011 & year < 2018) %>%
  group_by(m_yr) %>%
  nest()

#plot that needs to be dealt with later
clipped_monthly <- subset(peat6_monthly, year > 2011 & year < 2018)
clipped_monthly$date <- as.Date(clipped_monthly$datetime)
clipped_monthly$GPP_CH4_mi <- mi_timeseries(gpp_ANNnight, wm, data_list = by_month)
clipped_monthly$Tair_CH4_mi <- mi_timeseries(TA.x, wm, data_list = by_month)

# Monte Carlo significance thresholds (dont run everytime as they take a while)
sig_gpp <- conf_series(gpp_ANNnight, wm, data_list = by_month, runs = 100, alpha = 0.05)
sig_Tair <- conf_series(TA.x, wm, data_list = by_month, runs = 100, alpha = 0.05)

# clipped_monthly$Tair_ma <- na.ma(ma(clipped_monthly$Tair_ma, 3))
# clipped_monthly$GPP_ma <- na.ma(ma(clipped_monthly$GPP_ma, 3))

# Correct MI values of bias due to sample size, now anything over zero is significant at p < 0.01
clipped_monthly$TairMI_corrected <- clipped_monthly$Tair_CH4_mi - sig_Tair
clipped_monthly$gppMI_corrected <- clipped_monthly$GPP_CH4_mi - sig_gpp

a <- ggplot(clipped_monthly) +
  geom_point(aes(x = date, y = TairMI_corrected), color = "red", alpha = 0.5) +
  geom_line(aes(x = date, y = ma(TairMI_corrected, 3)), color = "red", size = 1) +
  geom_point(aes(x = date, y = gppMI_corrected), color = "dark green", alpha = 0.5) +
  geom_line(aes(x = date, y = ma(gppMI_corrected, 3)), color = "dark green", size = 1) +  
  scale_x_date(date_breaks = "1 year", labels = date_format("%Y")) +
  ylab(expression(bolditalic(MI)~"(x,"~F[CH4]~")")) + theme_bw() + xlab("")

b <- ggplot(subset(peat6_daily, year > 2011 & year < 2018), aes(x=as.Date(datetime), y=Cond)) +
  geom_line(color = "blue") +
  scale_x_date(date_breaks = "1 year", labels = date_format("%Y")) +
  ylab("Conductivity (mS)") + xlab("Year") +
  theme_bw()
  
grid.arrange(a, b, ncol=1)
```

```{r tr_GPP_to_CH4, fig.cap="Normalized transfer entropy (***T***) from (top panel) half-hourly GEP to F~CH4~ and (bottom panel) T~a~ to F~CH4~ over the growing season during years of low salinity (2012-2013) and high salinity (2015-2016). The red line represents significance threshold (*P* < 0.05) based on Monte Carlo reshuffling of the time series. Other lines represented ***T*** at various lags of GEP or T~a~ and color demonstrates mean conductivity (mS) during the respective year. Years 2014 and 2017 are omitted from analysis because other disturbance events affected wetlands processes and confound entropy analyses.", fig.height=4, fig.width=7.5, dpi=600}
source("R/TR_functions.R")
source("R/transformations.R")

#apply anomaly filter
anom_data <- peat6_all %>%
  arrange(year, time) %>%
  mutate(CH4_anom = anom_filter(wm_gf),
         TA_anom = anom_filter(TA.x),
         GPP_anom = anom_filter(gpp_ANNnight))

anom_data <- arrange(anom_data, datetime)
anom_data$CH4na_anom <- ifelse(is.na(anom_data$wm), NA, anom_data$CH4_anom) # re-insert missing values

# Focus only on high v. low salinity years without additional disturbance
# other disturbance includes the 2014 insect outbreak and 2017 flushing events
anom_data <- subset(anom_data, year %in% c(2012, 2013, 2015, 2016))

#create data list by annual growing season
by_year <- anom_data %>%
  filter(DOY > 100 & DOY < 300) %>%
  group_by(year) %>%
  nest()

#calculate lagged transfer entropy time series (up to 2 day lag at half-hourly timestep)
# for GPP -> CH4
tr_wm_gpp <- tr_timeseries(GPP_anom, CH4na_anom, data_list = by_year, type = "observed", 
                           lags = 72, bins = 10, normalize = T)

mc_wm_gpp <- tr_timeseries(GPP_anom, CH4na_anom, data_list = by_year, type = "shuffled", 
                           lags = 72, bins = 10, runs = 25, alpha = 0.05, normalize = T)
# for TA -> CH4
tr_wm_ta <- tr_timeseries(TA_anom, CH4na_anom, data_list = by_year, type = "observed", 
                           lags = 72, bins = 10, normalize = T)

mc_wm_ta <- tr_timeseries(TA_anom, CH4na_anom, data_list = by_year, type = "shuffled", 
                           lags = 72, bins = 10, runs = 25, alpha = 0.05, normalize = T)

#unlist data to tidy dataframe
gpp.wm_df <- tidy_list(tr_wm_gpp); gpp.wm_shuf <- tidy_list(mc_wm_gpp)
ta.wm_df <- tidy_list(tr_wm_ta); ta.wm_shuf <- tidy_list(mc_wm_ta)

#add mean annual conductivity to dataframes by year
mean_cond <- anom_data %>%
  filter(DOY > 100 & DOY < 300) %>%
  group_by(year) %>%
  summarise(`Cond. (mS)` = mean(Cond, na.rm = T))

gpp.wm_df <- merge(gpp.wm_df, mean_cond, all.x = T) 
ta.wm_df <- merge(ta.wm_df, mean_cond, all.x = T) 

a <- ggplot() +
  geom_line(data = gpp.wm_df, aes(x = hour, y = tr, color = `Cond. (mS)`)) +
  geom_line(data = gpp.wm_shuf, aes(x = hour, y = tr), color = "red") +
  facet_wrap(~year, nrow = 1) +
  scale_x_continuous(breaks = seq(0, 48, by = 6)) +
  xlab("") + ylab(expression(bolditalic(T)~"("~GEP %->% F[CH4]~")")) +
  theme(legend.position = "none")

b <- ggplot() +
  geom_line(data = ta.wm_df, aes(x = hour, y = tr, color = `Cond. (mS)`)) +
  geom_line(data = ta.wm_shuf, aes(x = hour, y = tr), color = "red") +
  facet_wrap(~year, nrow = 1) +
  scale_x_continuous(breaks = seq(0, 48, by = 6)) +
  xlab("Lag (hours)") + ylab(expression(bolditalic(T)~"("~T[a] %->% F[CH4]~")")) +
  theme(legend.margin = margin(0, 0, 0, 0),
        legend.position=c(.31, .7), legend.key.size =  unit(0.12, "in"),
        legend.text = element_text(size=8), legend.title = element_text(size=8.5, face = "bold"),
        legend.background = element_rect(fill = "transparent"))


#Multiple plots aligned
iA <- ggplotGrob(a)
iB <- ggplotGrob(b)

maxWidth = grid::unit.pmax(iA$widths[2:5], iB$widths[2:5])
iA$widths[2:5] <- as.list(maxWidth); iB$widths[2:5] <- as.list(maxWidth); 

grid.arrange(iA, iB, ncol=1)
```


```{r bias_by_samples, fig.height= 5, fig.width=6}
#shuffle data for comparison w/ monthly gap magnitude retained
peat6_all <- peat6_all %>%
  group_by(month) %>%
  mutate(H_shuf = sample(TA.x, length(TA.x), replace = F),
         G_shuf = sample(gpp_ANNnight, length(gpp_ANNnight), replace = F),
         wm_shuf = sample(wm, length(wm), replace = F))

clipped_monthly$T_shuf <- mi_timeseries(H_shuf, wm_shuf, data_list = by_month)
clipped_monthly$G_shuf <- mi_timeseries(G_shuf, wm_shuf, data_list = by_month)

ggplot() +
  geom_point(data = clipped_monthly, aes(x = CH4_obs, y = G_shuf)) +
  geom_point(data = clipped_monthly, aes(x = CH4_obs, y = T_shuf), color = "red") +
  xlab("Number of flux obs.") + ylab("MI (reshuffled data)")
```

```{r pre_salinity_models, fig.cap="", fig.height=6, fig.width=3.5, dpi=600}
# train nn model on pre-salinity rise years and use to calculate reduction in component fluxes 
pre_rise <- peat6_daily %>%
  filter(year > 2011 & year < 2015) %>%
  select(mgCH4, gGEP, gER, mET, PAR, H, Tair, Tw, Ts, mVPD, PA, u., Rain, WTD)

# Random forest model for GEP trained pre-salinity rise
pre_GEP <- train(gGEP ~ Tair + PAR + mVPD + PA + u. + WTD, data = pre_rise,
                      method = "rf",
                      trControl = trainControl(method = "cv", number = 5),
                      preProcess = c("medianImpute"),
                      #tuneGrid = expand.grid(.decay = c(.1, 0.05, .01), .size = c(3, 5, 7, 9)),
                      na.action = na.pass,
                      linout = T)

# Random forest model for FCH4 trained pre-salinity rise
pre_CH4 <- train(mgCH4 ~ gGEP + Tair + mVPD + PA + u. + WTD, data = pre_rise,
                      method = "rf",
                      trControl = trainControl(method = "cv", number = 5),
                      preProcess = c("medianImpute"),
                      #tuneGrid = expand.grid(.decay = c(.1, 0.05, .01), .size = c(3, 5, 7, 9)),
                      na.action = na.pass)

# generate predictions for high salinity years for GEP and FCH4
pre_rise$GEPpred <- predict.train(pre_GEP, pre_rise, na.action = na.pass)
pre_rise$CH4pred <- predict.train(pre_CH4, pre_rise, na.action = na.pass)

# save ob v. pred summary statistics
GEPregr <- summary(lm(gGEP ~ GEPpred, data = pre_rise))
CH4regr <- summary(lm(mgCH4 ~ CH4pred, data = pre_rise))

a <- ggplot(pre_rise, aes(x = CH4pred, y = mgCH4)) +
  geom_point(alpha = 0.25) +
  geom_abline(intercept = 0, slope = 1) +
  xlab(expression(F[CH4-Pred.]~" (mg C"~m^{-2}~d^{-1}~")")) +
  ylab(expression(F[CH4-Obs.]~" (mg C"~m^{-2}~d^{-1}~")")) +
  ggtitle("Pre-salinity rise (2012-2014)")

b <- ggplot(pre_rise, aes(x = GEPpred*-1, y = gGEP*-1)) +
  geom_point(alpha = 0.25) +
  geom_abline(intercept = 0, slope = 1) +
  ylab(expression(GEP[Obs.]~"("~g~C~m^{-2}~d^{-1}~")")) +
  xlab(expression(GEP[Pred.]~"("~g~C~m^{-2}~d^{-1}~")"))

grid.arrange(a, b, ncol = 1)
```

```{r salinity_rise_predictions, fig.width=7.5, fig.height=4}
# extract data to make predictions on the salinity rise years
rise_years <- peat6_daily %>%
  filter(year > 2014 & year < 2017) %>%
  select(datetime, year, mgCH4, gGEP, gER, mET, PAR, H, Tair, Tw, Ts, mVPD, PA, u., Rain, WTD)

# generate predictions for high salinity years for GEP and FCH4
rise_years$GEPpred <- predict.train(pre_GEP, rise_years, na.action = na.pass)
rise_years$CH4pred <- predict.train(pre_CH4, rise_years, na.action = na.pass)

#plotting all the measures
a <- ggplot(rise_years) +
  geom_line(aes(x=datetime, y=mgCH4)) +
  geom_line(aes(x=datetime, y=CH4pred), color = "red") +
  ylab(expression(F[CH4]~" (mg C"~m^{-2}~d^{-1}~")")) + xlab("") +
  ggtitle("High salinity period (2015-2016)") +
  theme_classic()

b <- ggplot(rise_years) +
  geom_line(aes(x=datetime, y=gGEP*-1)) +
  geom_line(aes(x=datetime, y=GEPpred*-1), color = "red") +
  ylab(expression("GEP "~"("~g~C~m^{-2}~d^{-1}~")")) + xlab("Date") +
  theme_classic()

grid.arrange(a, b, ncol = 1)
```

```{r flux_reduction_estimates}
#calculate annual budgets for RF predictions and observations during salinity years
annual_budgets <- rise_years %>%
  group_by(year) %>%
  summarise(CH4yr = mean(mgCH4)*365/1000,
            CH4yr_rf = mean(CH4pred)*365/1000,
            GEPyr = mean(gGEP)*365,
            GEPyr_rf = mean(GEPpred)*365) %>%
  mutate(CH4pc = (CH4yr - CH4yr_rf)*100/CH4yr,
         GEPpc = (GEPyr - GEPyr_rf)*100/GEPyr)
```

<!-- ## Water chemistry -->

<!-- ```{r fig4, echo = F} -->
<!-- only16 <- subset(peat6_daily, year > 2015) -->
<!-- only16$jday <- lubridate::yday(only16$datetime) -->

<!-- only16$season <- ifelse(only16$jday %in% c(0:100) | only16$jday %in% c(300:365), "fallow",  -->
<!--                            "growing") -->

<!-- # ggplot(only16, aes(x=datetime)) + -->
<!-- #   geom_line(aes(y = DOrange1), color="red") + -->
<!-- #   geom_line(aes(y = DOdiff), color="blue") -->
<!-- #  -->
<!-- # ggplot(only16, aes(x=mgCH4, y=DOrange1, color=season)) + -->
<!-- #   geom_point() -->

<!-- regr <- lm(DOrange1 ~ mgCH4, data = subset(only16, season == "growing")); summary(regr) -->
<!-- ``` -->

```{r test, echo = F}
#CH4sub <- peat6_all[!is.na(peat6_all$wm), ]

by_year <- peat6_daily %>%
  filter(year > 2011 & year < 2018) %>%
  group_by(year) %>%
  select(mgCH4, gGEP, mET, H, Tair, mVPD, u., Rain, WTD) %>%
  nest()

net_model <- function(df) {
  train(mgCH4 ~ ., data = df, method = "glmnet",
                 trControl = trainControl(method = "cv"),
                 preProcess = c("center", "scale", "medianImpute", "BoxCox"),
                 tuneGrid = expand.grid(.alpha = 1, .lambda = 0.1),
                 na.action = na.pass)
}

# hh_model <- function(df) {
#   train(wm ~ gpp_ANNnight + wq_gf + wt_gf + TA.y + VPD + ustar + PRECIP + WT + WD,
#         data = df,
#         method = "glmnet",
#         preProcess = c("center", "scale", "medianImpute", "BoxCox"),
#         na.action = na.pass)
# }

# subset <- peat6_daily %>%
#   ungroup() %>%
#   select(mgCH4, gGEP, gER, mET, H, Tair, Tw, mVPD, u., Rain, WTD) %>%
#   na.omit()

# #caret approach
# glm_reg <- train(wm ~ gpp_ANNnight + wq_gf + wt_gf + TA.y + VPD + ustar + PRECIP + WT + WD, 
#                  data = CH4sub, method = "glmnet",
#                  trControl = trainControl(method = "cv"),
#                  preProcess = c("center", "scale", "medianImpute"),
#                  #tuneGrid = expand.grid(.alpha = 1, .lambda = c(0, 0.001, 0.1, 1, 5, 10, 20, 50)),
#                  na.action = na.pass)

by_year <- by_year %>%
  mutate(model = map(data, net_model),
         Imp = map(model, varImp))

impo_list <- by_year$Imp

a <- impo_list[[1]]$importance
a$year <- 2012
a$vars <- rownames(a)

b <- impo_list[[2]]$importance
b$year <- 2013
b$vars <- rownames(b)

c <- impo_list[[3]]$importance
c$year <- 2014
c$vars <- rownames(c)

d <- impo_list[[4]]$importance
d$year <- 2015
d$vars <- rownames(d)

e <- impo_list[[5]]$importance
e$year <- 2016
e$vars <- rownames(e)

f <- impo_list[[6]]$importance
f$year <- 2017
f$vars <- rownames(f)

all_now <- do.call("rbind", list(a, b, c, d, e, f))

ggplot(all_now, aes(x=year, y=Overall, color=vars)) +
  #stat_smooth(se=F) +
  geom_point(size = 2) +
  geom_line()
```

# Discussion

# Acknowledgements
This research was supported in part by the U.S. Department of Energy’s Office of Science and its funding of Ameriflux core sites (Ameriflux contract 7079856), and the California Division of Fish and Wildlife, through a contract of the California Department of Water Resources (Award 4600011240).

# References

